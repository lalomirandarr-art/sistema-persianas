<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio de Clientes</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* --- ESTILOS GENERALES (Basados en tu referencia) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; }
        .main-container { padding: 40px; max-width: 1400px; margin: auto; }

        /* --- HEADER (IGUAL A TU REFERENCIA) --- */
        /* Aseg√∫rate de tener esto en tu style.css o d√©jalo aqu√≠ si es espec√≠fico */
        .header { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; max-width: 1400px; margin: auto; height: 70px; }
        .nav-links a, .dropbtn { text-decoration: none; color: #333; margin-left: 20px; font-weight: 500; font-size: 1em; }
        /* ... resto de estilos del men√∫ ... */

        /* --- PANEL DE CONTROLES (FILTRO Y BOTONES) --- */
        .controls-panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filter-item {
            flex: 1;
            min-width: 250px; /* Un poco m√°s ancho para escribir nombres */
        }

        .filter-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .actions-group {
            display: flex;
            gap: 10px;
        }

        .btn-control {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            display: flex; 
            align-items: center; 
            gap: 8px;
            text-decoration: none; /* Por si es un enlace */
        }
        .btn-green { background: #28a745; }
        .btn-green:hover { background: #218838; }

        /* --- TABLA RESPONSIVA (LA CLAVE PARA EL CELULAR) --- */
        .table-responsive {
            width: 100%;
            overflow-x: auto; /* Permite deslizar si la tabla es muy ancha */
            -webkit-overflow-scrolling: touch; /* Suavidad en iPhone */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: white;
        }

        table { width: 100%; border-collapse: collapse; min-width: 900px; /* Fuerza el ancho m√≠nimo para que aparezca el scroll */ }
        
        th { 
            background-color: #001f3f; /* Mismo azul que tu referencia */
            color: white; 
            padding: 12px 15px; 
            text-align: left; 
            white-space: nowrap;
        }
        td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            color: #333;
            vertical-align: middle;
        }
        tr:hover { background-color: #f1f5f9; }

        /* --- BADGES Y BOTONES DE TABLA --- */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .badge-cliente { background-color: #d4edda; color: #155724; }
        .badge-prospecto { background-color: #fff3cd; color: #856404; }

        .btn-icon { background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0 5px; }
        .btn-icon:hover { transform: scale(1.2); }

        /* --- PAGINACI√ìN --- */
        .pagination-container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 20px; 
            padding: 10px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .btn-paginacion { 
            background-color: #001f3f; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 5px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .btn-paginacion:disabled { background-color: #ccc; cursor: not-allowed; }
        .page-info { font-weight: bold; color: #555; }

        /* --- ESTILOS M√ìVILES (ADAPTADOS) --- */
        @media (max-width: 768px) {
            .main-container { padding: 10px; }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                gap: 15px;
            }
            .filter-item { min-width: 0; }
            .actions-group { width: 100%; }
            .btn-control { width: 100%; justify-content: center; }
            
            /* El modal tambi√©n necesita ajuste m√≥vil */
            .modal-content { width: 95%; padding: 15px; margin: auto; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }

        /* --- MODAL (Manteniendo tus estilos previos, simplificados) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; border-radius: 10px; padding: 30px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <header class="header">
        <div class="nav-container">
            <div class="logo"><img src="/IMG/logo.jpeg" alt="Logo" style="height: 50px;"></div>
            <nav class="nav-links">
                <a href="index.html" class="btn-logout">Cerrar Sesi√≥n</a>
                <a href="/inicio.html">Inicio</a>
                <a href="/productos.html">Productos</a>
                <a href="/clientes.html">Clientes</a>
                <div class="dropdown" style="display:inline-block;">
                    <button class="dropbtn" style="background:none; border:none; cursor:pointer;">Cotizaciones ‚ñº</button>
                    <div class="dropdown-content" style="position:absolute; background:white; box-shadow:0 8px 16px rgba(0,0,0,0.2); display:none;">
                        <a href="/cotizaciones.html" style="display:block; padding:12px;">Nueva Cotizaci√≥n</a>
                        <a href="/control-cotizaciones.html" style="display:block; padding:12px;">Control Cotizaciones</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="main-container">
        
        <div style="margin-bottom: 20px;">
            <h1 style="color: #333; margin:0;">Directorio de Clientes</h1>
            <p style="color: #666; margin:5px 0 0 0;">Gesti√≥n completa de cartera.</p>
        </div>

        <div class="controls-panel">
            <div class="filter-item">
                <label>üîç Buscar Cliente:</label>
                <input type="text" id="inputBusqueda" placeholder="Nombre, Empresa..." onkeyup="buscarCliente()">
            </div>
            
            <div class="actions-group">
                <button class="btn-control btn-green" onclick="abrirModalNuevo()">
                    ‚ûï Registrar Cliente
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nombre / Raz√≥n Social</th>
                        <th>Email</th>
                        <th>Tel√©fono</th>
                        <th>Tipo</th>
                        <th>Canal</th>
                        <th style="text-align: center;">Opciones</th>
                    </tr>
                </thead>
                <tbody id="lista-clientes">
                    </tbody>
            </table>
        </div>

        <div class="pagination-container" id="panel-paginacion">
            <button class="btn-paginacion" id="btn-prev" onclick="cambiarPagina(-1)">‚¨ÖÔ∏è Anterior</button>
            <span class="page-info" id="lbl-page-info">Cargando...</span>
            <button class="btn-paginacion" id="btn-next" onclick="cambiarPagina(1)">Siguiente ‚û°Ô∏è</button>
        </div>

    </div>

    <div id="modal-cliente" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h2 id="modal-titulo" style="margin:0;">Cliente</h2>
                <button onclick="cerrarModal()" style="background:none; border:none; font-size:1.5em; cursor:pointer;">√ó</button>
            </div>
            
            <form id="form-cliente" onsubmit="guardarCliente(event)">
                <input type="hidden" id="cliente-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Raz√≥n Social</label>
                        <input type="text" id="razonSocial">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="telefono">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="tipo">
                            <option value="Prospecto">Prospecto</option>
                            <option value="Cliente">Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Canal</label>
                        <select id="canal">
                            <option value="WhatsApp">WhatsApp</option>
                            <option value="Correo">Correo</option>
                            <option value="Referido">Referido</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="full-width"><h3 style="margin:10px 0; color:#007bff; font-size:1em; border-bottom:1px solid #eee;">üìç Direcci√≥n</h3></div>
                    
                    <div class="form-group"><label>Calle</label><input type="text" id="calle"></div>
                    <div class="form-group"><label>Colonia</label><input type="text" id="colonia"></div>
                    <div class="form-group"><label>Localidad</label><input type="text" id="localidad"></div>
                    <div class="form-group"><label>CP</label><input type="text" id="cp"></div>
                    <div class="form-group"><label>Estado</label><input type="text" id="estado"></div>
                    <div class="form-group full-width">
                        <label>Referencia</label>
                        <textarea id="referencia" rows="2"></textarea>
                    </div>
                </div>
                <div style="margin-top:20px; text-align:right; border-top:1px solid #eee; padding-top:20px;">
                    <button type="button" onclick="cerrarModal()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer;">Cancelar</button>
                    <button type="submit" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let paginaActual = 1;
        let totalPaginas = 1;
        let busquedaActual = "";
        const filasPorPagina = 20;

        // --- CARGAR DATOS (PAGINADOS DESDE EL SERVIDOR) ---
        async function cargarClientes(pagina = 1) {
            paginaActual = pagina;
            const input = document.getElementById('inputBusqueda');
            busquedaActual = input.value.trim();
            const tbody = document.getElementById('lista-clientes');
            
            // Indicador de carga
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Cargando datos...</td></tr>';

            try {
                // Petici√≥n al backend con p√°gina y b√∫squeda
                const res = await fetch(`/clientes?page=${pagina}&limit=${filasPorPagina}&search=${encodeURIComponent(busquedaActual)}`);
                const respuesta = await res.json();
                
                const lista = respuesta.datos || [];
                const totalRegistros = respuesta.total || 0;
                totalPaginas = respuesta.totalPaginas || 1;

                renderizarTabla(lista, totalRegistros);
                actualizarControlesPaginacion(totalRegistros);

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Error de conexi√≥n</td></tr>';
            }
        }

        // --- RENDERIZAR TABLA ---
        function renderizarTabla(lista, totalRegistros) {
            const tbody = document.getElementById('lista-clientes');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#777;">No se encontraron coincidencias.</td></tr>';
                return;
            }

            lista.forEach((cliente, index) => {
                const numeroReal = ((paginaActual - 1) * filasPorPagina) + (index + 1);
                const nombreMostrar = cliente.razonSocial ? `${cliente.nombre} (${cliente.razonSocial})` : cliente.nombre;
                const claseTipo = cliente.tipo === 'Cliente' ? 'badge-cliente' : 'badge-prospecto';

                const fila = `
                    <tr>
                        <td style="color:#666;">${numeroReal}</td>
                        <td style="font-weight:bold;">${nombreMostrar}</td>
                        <td>${cliente.email || '-'}</td>
                        <td>${cliente.telefono || '-'}</td>
                        <td><span class="badge ${claseTipo}">${cliente.tipo || 'Prospecto'}</span></td>
                        <td>${cliente.canal || '-'}</td>
                        <td style="text-align: center; white-space: nowrap;">
                            <button class="btn-icon" style="color:#28a745;" onclick="abrirModalEditar('${cliente._id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-icon" style="color:#dc3545;" onclick="eliminarCliente('${cliente._id}')" title="Borrar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            });
        }

        // --- ACTUALIZAR BOTONES PAGINACI√ìN ---
        function actualizarControlesPaginacion(totalRegistros) {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const lblInfo = document.getElementById('lbl-page-info');

            const inicio = (totalRegistros === 0) ? 0 : ((paginaActual - 1) * filasPorPagina) + 1;
            let fin = paginaActual * filasPorPagina;
            if (fin > totalRegistros) fin = totalRegistros;

            lblInfo.innerText = `${inicio} - ${fin} de ${totalRegistros}`;
            
            btnPrev.disabled = (paginaActual === 1);
            btnNext.disabled = (paginaActual >= totalPaginas || totalRegistros === 0);
        }

        function cambiarPagina(dir) {
            const nuevaPagina = paginaActual + dir;
            if (nuevaPagina > 0 && nuevaPagina <= totalPaginas) {
                cargarClientes(nuevaPagina);
            }
        }

        // --- BUSCADOR CON DELAY (Para no saturar) ---
        let timeoutBuscador;
        function buscarCliente() {
            clearTimeout(timeoutBuscador);
            timeoutBuscador = setTimeout(() => {
                cargarClientes(1); // Siempre volver a p√°gina 1 al buscar
            }, 400);
        }

        // --- FUNCIONES DEL MODAL (Nuevo / Editar / Guardar) ---
        function abrirModalNuevo() {
            document.getElementById('form-cliente').reset();
            document.getElementById('cliente-id').value = "";
            document.getElementById('modal-titulo').innerText = "Nuevo Cliente";
            document.getElementById('modal-cliente').style.display = "flex";
        }

        async function abrirModalEditar(id) {
            // Para editar, necesitamos los datos. Podemos pasarlos por param o buscarlos.
            // Opci√≥n r√°pida: buscar en la lista actual de memoria si quisi√©ramos, 
            // pero como est√° paginado, mejor hacemos fetch del server o usamos lo que hay en pantalla.
            // Para simplificar, asumimos que tienes la lista en memoria si quieres, 
            // pero haremos un fetch directo a los datos que ya tenemos cargados en la tabla si guard√°ramos la lista globalmente.
            // MEJORA: Haremos un truco, tomamos los datos de la fila? No, mejor traerlos bien.
            
            // Vamos a buscar en el backend el cliente espec√≠fico o usar un truco.
            // Como ya tenemos los ID, es seguro que existen. 
            // Haremos esto: recargar la variable listaClientes globalmente o buscar en DOM.
            // Para hacerlo robusto sin cambiar server: 
            // Vamos a confiar en que server.js ya env√≠a todos los datos en la lista paginada.
            // Pero como la funci√≥n `cargarClientes` no guarda en variable global `listaClientes`,
            // haremos un peque√±o fetch individual si quisieras ser muy estricto, 
            // O mejor a√∫n: Guardemos la respuesta del fetch en una variable global.

            // 1. Modificar cargarClientes para guardar en:
            // window.clientesActuales = lista; (Ya lo har√© yo abajo)
            
            const cliente = window.clientesActuales.find(c => c._id === id);
            if (!cliente) return alert("Error localizando cliente");

            document.getElementById('cliente-id').value = cliente._id;
            document.getElementById('nombre').value = cliente.nombre || '';
            document.getElementById('razonSocial').value = cliente.razonSocial || '';
            document.getElementById('email').value = cliente.email || '';
            document.getElementById('telefono').value = cliente.telefono || '';
            document.getElementById('tipo').value = cliente.tipo || 'Prospecto';
            document.getElementById('canal').value = cliente.canal || 'WhatsApp';
            
            document.getElementById('calle').value = cliente.calle || '';
            document.getElementById('colonia').value = cliente.colonia || '';
            document.getElementById('localidad').value = cliente.localidad || '';
            document.getElementById('cp').value = cliente.cp || '';
            document.getElementById('estado').value = cliente.estado || '';
            document.getElementById('referencia').value = cliente.referencia || '';

            document.getElementById('modal-titulo').innerText = "Editar Cliente";
            document.getElementById('modal-cliente').style.display = "flex";
        }

        function cerrarModal() {
            document.getElementById('modal-cliente').style.display = "none";
        }

        async function guardarCliente(e) {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            
            const datos = {
                nombre: document.getElementById('nombre').value,
                razonSocial: document.getElementById('razonSocial').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                tipo: document.getElementById('tipo').value,
                canal: document.getElementById('canal').value,
                calle: document.getElementById('calle').value,
                colonia: document.getElementById('colonia').value,
                localidad: document.getElementById('localidad').value,
                cp: document.getElementById('cp').value,
                estado: document.getElementById('estado').value,
                referencia: document.getElementById('referencia').value
            };

            const metodo = id ? 'PUT' : 'POST';
            if (id) datos.id = id;

            try {
                const res = await fetch('/clientes', {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                const r = await res.json();
                if (r.exito) {
                    alert("‚úÖ Guardado correctamente");
                    cerrarModal();
                    cargarClientes(paginaActual); // Recargar p√°gina actual
                } else {
                    alert("‚ùå Error: " + r.mensaje);
                }
            } catch (error) {
                alert("Error de conexi√≥n");
            }
        }

        // --- BORRAR ---
        async function eliminarCliente(id) {
            const pass = prompt("‚ö†Ô∏è ¬øEliminar Cliente?\nEscribe la contrase√±a (1234):");
            if (!pass) return;

            try {
                const res = await fetch('/clientes', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, password: pass })
                });
                const r = await res.json();
                if (r.exito) {
                    alert("üóëÔ∏è Eliminado");
                    cargarClientes(paginaActual);
                } else {
                    alert(r.mensaje);
                }
            } catch (error) {
                alert("Error al borrar");
            }
        }

        // Peque√±o ajuste para que 'abrirModalEditar' funcione
        // Interceptamos la respuesta para guardarla en memoria
        const originalCargar = cargarClientes;
        cargarClientes = async function(p) {
            paginaActual = p || 1;
            // Copia de la l√≥gica para poder asignar window.clientesActuales
            const input = document.getElementById('inputBusqueda');
            busquedaActual = input.value.trim();
            const tbody = document.getElementById('lista-clientes');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Cargando...</td></tr>';
            
            try {
                const res = await fetch(`/clientes?page=${paginaActual}&limit=${filasPorPagina}&search=${encodeURIComponent(busquedaActual)}`);
                const respuesta = await res.json();
                
                window.clientesActuales = respuesta.datos || []; // <--- ESTO ES LA CLAVE
                
                renderizarTabla(window.clientesActuales, respuesta.total);
                totalPaginas = respuesta.totalPaginas;
                actualizarControlesPaginacion(respuesta.total);
            } catch (e) { console.error(e); }
        }

        // INICIO
        document.addEventListener("DOMContentLoaded", () => {
            cargarClientes();
        });

    </script>
</body>
</html>