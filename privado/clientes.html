<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio de Clientes</title>
    <style>
        /* --- ESTILOS GENERALES (IGUALADOS A CONTROL COTIZACIONES) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; }
        
        /* HEADER (Igual a tu otra p√°gina) */
        .header { background-color: white; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .nav-container { width: 100%; max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo img { height: 50px; }
        .nav-links a, .dropbtn { text-decoration: none; color: #333; padding: 10px 15px; font-weight: 500; font-size: 16px; border-radius: 5px; transition: 0.3s; }
        .nav-links a:hover, .dropdown:hover .dropbtn { background-color: #f1f1f1; color: #007bff; }
        
        .main-container { padding: 40px; max-width: 1400px; margin: auto; }

        h1 { color: #333; margin-bottom: 30px; border-bottom: 3px solid #001f3f; display: inline-block; padding-bottom: 5px; }

        /* --- CONTROLES Y BUSCADOR --- */
        .controls-panel {
            background-color: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-item { flex: 1; min-width: 250px; }
        .filter-item label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .filter-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; box-sizing: border-box; }

        .actions-group { display: flex; gap: 10px; }
        .btn-control { color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
        .btn-control:hover { transform: scale(1.05); }
        .btn-green { background: #217346; } /* Excel */
        .btn-blue { background: #007bff; } /* Nuevo */

        /* --- TABLA (EST√âTICA ID√âNTICA) --- */
        .table-responsive { width: 100%; overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: white; }
        
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.95em; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #001f3f; color: white; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }

        /* --- PAGINACI√ìN --- */
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-paginacion { background-color: #001f3f; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-paginacion:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- RESPONSIVO (MOVIL) --- */
        @media (max-width: 768px) {
            .main-container { padding: 10px; }
            .controls-panel { flex-direction: column; }
            .actions-group { width: 100%; justify-content: space-between; }
            .btn-control { flex: 1; text-align: center; }

            /* Tabla tipo tarjetas */
            thead { display: none; }
            tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            td { display: block; text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid #eee; }
            td::before { 
                content: attr(data-label); 
                position: absolute; left: 15px; top: 12px; font-weight: bold; color: #001f3f; 
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="nav-container">
            <div class="logo"><img src="/IMG/logoPD.jpeg" alt="Logo"></div> <nav class="nav-links">
                <a href="/index.html">Cerrar Sesi√≥n</a>
                <a href="/inicio.html">Inicio</a>
                <a href="/productos.html">Productos</a>
                <a href="/clientes.html" style="font-weight: bold; color: #007bff;">Clientes</a>
                <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                <a href="/control-cotizaciones.html">Control Cotizaciones</a>
            </nav>
        </div>
    </header>

    <div class="main-container">
        <h1>üë• Directorio de Clientes</h1>

        <div class="controls-panel">
            <div class="filter-item">
                <label>üîç Buscar Cliente:</label>
                <input type="text" id="searchInput" placeholder="Escribe nombre, empresa o tel√©fono..." onkeyup="filtrarClientes()">
            </div>
            <div class="actions-group">
                <button onclick="alert('Funci√≥n para agregar nuevo cliente')" class="btn-control btn-blue">‚ûï Nuevo Cliente</button>
            </div>
        </div>

        <div class="table-responsive">
            <table id="tablaClientes">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Empresa</th>
                        <th>Tel√©fono</th>
                        <th>Email</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientesBody">
                    </tbody>
            </table>
        </div>

        <div class="pagination-container" id="panel-paginacion">
            <button class="btn-paginacion" id="btn-prev" onclick="cambiarPagina(-1)">‚¨ÖÔ∏è Anterior</button>
            <span class="page-info" id="lbl-page-info">Cargando...</span>
            <button class="btn-paginacion" id="btn-next" onclick="cambiarPagina(1)">Siguiente ‚û°Ô∏è</button>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let todosLosClientes = [];
        let clientesFiltrados = [];
        let paginaActual = 1;
        const filasPorPagina = 20;

        // --- 1. CARGAR DATOS ---
        async function cargarClientes() {
            try {
                // NOTA: Ajusta '/clientes' si tu ruta de API es diferente (ej: '/api/clientes')
                const respuesta = await fetch('/clientes'); 
                const datos = await respuesta.json();

                // Ordenar alfab√©ticamente por si acaso
                datos.sort((a, b) => {
                    // Intento robusto de obtener nombre para ordenar
                    const nA = (a.nombre || a.name || a.cliente || '').toLowerCase();
                    const nB = (b.nombre || b.name || b.cliente || '').toLowerCase();
                    return nA.localeCompare(nB);
                });

                todosLosClientes = datos;
                clientesFiltrados = datos; // Al inicio mostramos todos
                
                console.log("Clientes cargados:", todosLosClientes.length);
                renderizarTabla();

            } catch (error) {
                console.error("Error cargando clientes:", error);
                document.getElementById('clientesBody').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Error al cargar datos. Revisa la consola (F12).</td></tr>';
            }
        }

        // --- 2. RENDERIZAR TABLA (Pinta los datos) ---
        function renderizarTabla() {
            const tbody = document.getElementById('clientesBody');
            tbody.innerHTML = '';

            // C√°lculos de Paginaci√≥n
            const totalRegistros = clientesFiltrados.length;
            const totalPaginas = Math.ceil(totalRegistros / filasPorPagina) || 1;
            
            // Validar l√≠mites de p√°gina
            if (paginaActual < 1) paginaActual = 1;
            if (paginaActual > totalPaginas) paginaActual = totalPaginas;

            const inicio = (paginaActual - 1) * filasPorPagina;
            const fin = inicio + filasPorPagina;
            const datosPagina = clientesFiltrados.slice(inicio, fin);

            if (datosPagina.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron clientes.</td></tr>';
                actualizarControlesPaginacion(0, 0, 0);
                return;
            }

            datosPagina.forEach((c, index) => {
                // *** SOLUCI√ìN AL UNDEFINED ***
                // Buscamos el nombre en varias propiedades comunes.
                // Si tu base de datos usa "cliente", "nombre", "first_name", esto lo encontrar√°.
                const nombre = c.nombre || c.nombres || c.name || c.cliente || 'Sin Nombre';
                const apellido = c.apellido || c.apellidos || c.lastname || ''; // Puede estar vac√≠o
                const nombreCompleto = `${nombre} ${apellido}`.trim();
                
                const empresa = c.empresa || c.company || 'Particular';
                const telefono = c.telefono || c.phone || c.celular || '-';
                const email = c.email || c.correo || '-';
                const id = c._id || c.id;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="#">${inicio + index + 1}</td>
                    <td data-label="Nombre" style="font-weight:bold; color:#001f3f;">${nombreCompleto}</td>
                    <td data-label="Empresa">${empresa}</td>
                    <td data-label="Tel√©fono">${telefono}</td>
                    <td data-label="Email">${email}</td>
                    <td data-label="Acciones">
                        <button onclick="verDetalles('${id}')" style="background:none; border:none; cursor:pointer; font-size:1.2em;" title="Ver">üëÅÔ∏è</button>
                        <button onclick="editarCliente('${id}')" style="background:none; border:none; cursor:pointer; font-size:1.2em;" title="Editar">‚úèÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            actualizarControlesPaginacion(inicio + 1, Math.min(fin, totalRegistros), totalRegistros);
        }

        // --- 3. CONTROLES DE PAGINACI√ìN ---
        function actualizarControlesPaginacion(desde, hasta, total) {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const lblInfo = document.getElementById('lbl-page-info');

            lblInfo.innerText = `${desde} - ${hasta} de ${total}`;
            
            const totalPaginas = Math.ceil(clientesFiltrados.length / filasPorPagina);
            
            btnPrev.disabled = (paginaActual === 1 || total === 0);
            btnNext.disabled = (paginaActual >= totalPaginas || total === 0);
        }

        function cambiarPagina(direccion) {
            paginaActual += direccion;
            renderizarTabla();
        }

        // --- 4. BUSCADOR INSTANT√ÅNEO ---
        function filtrarClientes() {
            const texto = document.getElementById('searchInput').value.toLowerCase();

            clientesFiltrados = todosLosClientes.filter(c => {
                // Armamos string con todos los datos buscables para filtrar f√°cil
                const nombre = (c.nombre || c.nombres || c.name || c.cliente || '').toLowerCase();
                const apellido = (c.apellido || '').toLowerCase();
                const empresa = (c.empresa || '').toLowerCase();
                const tel = (c.telefono || '').toString();

                return nombre.includes(texto) || 
                       apellido.includes(texto) || 
                       empresa.includes(texto) || 
                       tel.includes(texto);
            });

            paginaActual = 1; // Resetear a p√°gina 1 al buscar
            renderizarTabla();
        }

        // --- FUNCIONES EXTRA (Placeholders) ---
        function verDetalles(id) {
            alert("Aqu√≠ abrir√≠as el modal de detalles para ID: " + id);
        }
        function editarCliente(id) {
            alert("Aqu√≠ abrir√≠as la edici√≥n para ID: " + id);
        }

        // INICIAR
        cargarClientes();

    </script>
</body>
</html>