<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial Financiero Completo</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.85em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: top; }
        th { background-color: #001f3f; color: white; }
        tr:hover { background-color: #f8f9fa; }
        
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.85em; background: #e2e6ea; color: #333; }
        .fecha { color: #666; font-size: 0.9em; }
        
        .costo { color: #dc3545; } 
        .utilidad { color: #28a745; font-weight: bold; } 
        .descuento { color: #d63384; font-weight: bold; } 
        .extras { color: #6610f2; font-weight: bold; } 
        .total { font-weight: bold; font-size: 1.1em; color: #000; }
        .detalle-gastos { font-size: 0.85em; color: #555; margin-top: 4px; border-left: 2px solid #ccc; padding-left: 5px; 
            /* 1. Definimos un ancho m√°ximo para forzar el salto de l√≠nea */
            max-width: 150px; 
            min-width: 120px;
            /* 3. Permitimos que el texto baje y rompa palabras si es necesario */
            white-space: normal;
            overflow-wrap: break-word; 
            word-wrap: break-word;}

        /* Estilo del Bot√≥n Borrar */
        .btn-borrar {
            background-color: transparent;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-borrar:hover {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>

    <header class="header">
    <div class="nav-container">
        <div class="logo">
            <img src="/IMG/logoPD.jpeg" alt="Logo">
        </div>
        
        <nav class="nav-links">
            <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
            <a href="/inicio.html">Inicio</a>
            <a href="/productos.html">Productos</a>
            <a href="/clientes.html">Clientes</a>
            
            <div class="dropdown">
                <button class="dropbtn">Cotizaciones ‚ñº</button>
                <div class="dropdown-content">
                    <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                    <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                </div>
            </div>
        </nav>
    </div>
    </header>

    <div class="historial-container">
        <h1>üìä Historial Detallado de Cotizaciones</h1>
        
        <div style="background-color: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üë§ Filtrar por Cliente:</label>
                <select id="filtro-cliente" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üõ†Ô∏è Filtrar por Cotizador:</label>
                <select id="filtro-cotizador" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>

            <div style="flex: 0;">
                <button onclick="limpiarFiltros()" style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Limpiar
                </button>
            </div>

        </div>

        <table id="tabla-cotizaciones">
            <thead>
                <tr>
                    <th>Fecha / Cliente</th>
                    <th>Cotizador</th>
                    <th>Producto</th>
                    <th>Medidas</th>
                    <th>Costo Neto</th>
                    <th>Utilidad</th>
                    <th>Descuento</th>
                    <th>Gastos Extra</th>
                    <th>Venta Final</th>
                    <th style="text-align: center;">Acci√≥n</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

   <script>
        let todasLasCotizaciones = []; // Aqu√≠ guardaremos la copia maestra de los datos

    // 1. CARGAR DATOS DEL SERVIDOR
    async function cargarHistorial() {
        try {
            const respuesta = await fetch('/cotizaciones');
            todasLasCotizaciones = await respuesta.json();

            // Una vez descargados, llenamos los filtros y mostramos la tabla completa
            llenarOpcionesFiltros();
            renderizarTabla(todasLasCotizaciones);

        } catch (error) {
            console.error(error);
            alert("Error al cargar historial.");
        }
    }

    // 2. DIBUJAR LA TABLA (Recibe una lista de datos)
    function renderizarTabla(datos) {
        const tabla = document.querySelector('#tabla-cotizaciones tbody');
        
        if (datos.length === 0) {
            tabla.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px; color: #666;">No se encontraron coincidencias.</td></tr>';
            return;
        }

        tabla.innerHTML = ''; 
        
        datos.forEach(c => {
            const fecha = new Date(c.fecha).toLocaleDateString('es-MX', { 
                month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' 
            });

            // Formatos de dinero y textos...
            const cotizador = c.quienCotiza ? c.quienCotiza : '<span style="color:#ccc;">---</span>';
            const costo = c.costoNeto ? `$${c.costoNeto.toFixed(2)}` : 'N/A';
            const montoUtilidad = c.montoUtilidad ? c.montoUtilidad : (c.precioConUtilidad && c.costoNeto ? c.precioConUtilidad - c.costoNeto : 0);
            const porcentajeUtil = c.porcentajeUtilidad ? `(${c.porcentajeUtilidad}%)` : '';
            
            let infoDescuento = c.porcentajeDescuento > 0 ? `<span class="descuento">-${c.porcentajeDescuento}%</span>` : '<span style="color:#ccc;">-</span>';
            
            let infoGastos = '<span style="color:#ccc;">-</span>';
            if (c.totalGastosAdicionales > 0) {
                infoGastos = `<span class="extras">+$${c.totalGastosAdicionales.toFixed(2)}</span>`;
                if (c.gastosAdicionales && c.gastosAdicionales.length > 0) {
                    infoGastos += `<div class="detalle-gastos">`;
                    c.gastosAdicionales.forEach(g => { infoGastos += `<div>‚Ä¢ ${g.descripcion}: $${g.monto}</div>`; });
                    infoGastos += `</div>`;
                }
            }

            let infoIVA = '';
            if (c.iva && c.iva > 0) {
                infoIVA = `<div style="font-size: 0.75em; color: #666; font-weight: normal; margin-top: 4px;">‚úî Incluye IVA: $${c.iva.toFixed(2)}</div>`;
            } else {
                infoIVA = `<div style="font-size: 0.75em; color: #ccc; font-weight: normal; margin-top: 4px; font-style: italic;">(Sin IVA)</div>`;
            }

            const fila = `
                <tr>
                    <td><strong>${c.cliente}</strong><br><span class="fecha">${fecha}</span></td>
                    <td style="color: #007bff; font-weight: bold;">${cotizador}</td>
                    <td>${c.producto}<br><span class="badge">${c.tela}</span></td>
                    <td>${c.medidas.ancho} x ${c.medidas.alto} m<br>Cant: ${c.cantidad}</td>
                    <td class="costo">${costo}</td>
                    <td class="utilidad">$${montoUtilidad.toFixed(2)} <br><span style="font-size:0.8em; color:#666;">${porcentajeUtil}</span></td>
                    <td>${infoDescuento}</td>
                    <td>${infoGastos}</td>
                    
                    <td class="total">
                        $${c.total.toFixed(2)}
                        ${infoIVA}
                    </td>
                    
                    <td style="text-align: center;">
                        <button class="btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Eliminar Cotizaci√≥n">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
            tabla.innerHTML += fila;
        });
    }

    // 3. LLENAR LOS SELECTS AUTOM√ÅTICAMENTE
    function llenarOpcionesFiltros() {
        const selectCliente = document.getElementById('filtro-cliente');
        const selectCotizador = document.getElementById('filtro-cotizador');

        // Usamos Set para obtener valores √∫nicos (sin repetidos)
        const clientesUnicos = [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort();
        const cotizadoresUnicos = [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort(); // filter(Boolean) quita nulos

        // Llenar Clientes
        clientesUnicos.forEach(cliente => {
            selectCliente.add(new Option(cliente, cliente));
        });

        // Llenar Cotizadores
        cotizadoresUnicos.forEach(cotizador => {
            selectCotizador.add(new Option(cotizador, cotizador));
        });
    }

    // 4. APLICAR FILTROS (Se ejecuta al cambiar los selects)
    function aplicarFiltros() {
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;

        // Filtramos la lista maestra
        const listaFiltrada = todasLasCotizaciones.filter(c => {
            // Si hay un cliente seleccionado, debe coincidir. Si no, pasa (true).
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            // Si hay un cotizador seleccionado, debe coincidir.
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;

            return coincideCliente && coincideCotizador;
        });

        // Redibujamos la tabla solo con los que pasaron el filtro
        renderizarTabla(listaFiltrada);
    }

    // 5. LIMPIAR FILTROS
    function limpiarFiltros() {
        document.getElementById('filtro-cliente').value = "";
        document.getElementById('filtro-cotizador').value = "";
        renderizarTabla(todasLasCotizaciones);
    }

    // --- FUNCI√ìN DE BORRADO (IGUAL QUE ANTES) ---
    async function confirmarBorrado(id) {
        const password = prompt("üîí ACCESO RESTRINGIDO\nPara eliminar esta cotizaci√≥n, ingresa la contrase√±a de administrador:");
        if (!password) return;

        try {
            const res = await fetch('/cotizaciones', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, password: password })
            });

            const data = await res.json();

            if (data.exito) {
                alert("‚úÖ " + data.mensaje);
                cargarHistorial(); // Recargamos todo
            } else {
                alert("‚õî Error: " + data.mensaje); 
            }

        } catch (error) {
            alert("Error de conexi√≥n con el servidor.");
        }
    }

    // Iniciar
    cargarHistorial();
    </script>
</body>
</html>