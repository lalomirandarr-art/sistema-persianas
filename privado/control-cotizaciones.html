<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial Financiero Completo</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.9em; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #001f3f; color: white; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        
        .total { font-weight: bold; font-size: 1.1em; color: #28a745; }

        .btn-borrar {
            background-color: transparent; border: none; color: #dc3545;
            font-size: 1.1em; cursor: pointer; transition: transform 0.2s;
            margin-left: 10px;
        }
        .btn-borrar:hover { transform: scale(1.2); }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .id-row { 
            font-weight: bold; color: #001f3f; background: #eef2f5; 
            padding: 4px 8px; border-radius: 4px; display: inline-block;
            font-size: 0.9em;
        }

        .badge-status {
            background-color: #e3f2fd; color: #0d47a1;
            padding: 5px 10px; border-radius: 15px;
            font-size: 0.85em; font-weight: bold; display: inline-block;
        }

        /* --- ESTILOS DE LA PANTALLA DE CARGA --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-family: sans-serif;
        }
        .progress-container {
            width: 80%; max-width: 600px; background: #333;
            border-radius: 10px; overflow: hidden; margin-top: 20px;
            border: 2px solid #555;
        }
        .progress-bar {
            height: 30px; width: 0%; background: #28a745; transition: width 0.1s linear;
        }
        .loader-text { font-size: 1.5em; margin-bottom: 10px; }
        .counter-text { font-size: 1.2em; color: #aaa; margin-top: 5px; }

        /* --- NUEVOS ESTILOS PAGINACI√ìN --- */
        .pagination-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-paginacion {
            background-color: #001f3f; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .btn-paginacion:disabled { background-color: #ccc; cursor: not-allowed; }
        .page-info { font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-text">üîÑ Importando Cotizaciones... Por favor espere.</div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="counter-text" class="counter-text">0 / 0</div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #ccc;">No cierres ni recargues la p√°gina.</p>
    </div>

    <header class="header">
    <div class="nav-container">
        <div class="logo"><img src="/IMG/logoPD.jpeg" alt="Logo"></div>
        <nav class="nav-links">
            <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
            <a href="/inicio.html">Inicio</a>
            <a href="/productos.html">Productos</a>
            <a href="/clientes.html">Clientes</a>
            <div class="dropdown">
                <button class="dropbtn">Cotizaciones ‚ñº</button>
                <div class="dropdown-content">
                    <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                    <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                </div>
            </div>
        </nav>
    </div>
    </header>

    <div class="historial-container">
        <h1>üìä Historial Resumido de Cotizaciones</h1>
        
        <input type="file" id="input-excel-importar" style="display: none;" accept=".xlsx, .xls" onchange="procesarArchivoExcel(this)">

        <div style="background-color: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üë§ Filtrar por Cliente:</label>
                <select id="filtro-cliente" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üõ†Ô∏è Filtrar por Cotizador:</label>
                <select id="filtro-cotizador" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 0; display: flex; gap: 10px;">
                <button onclick="limpiarFiltros()" style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Limpiar
                </button>
                <button onclick="exportarExcel()" style="background-color: #217346; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    ‚¨áÔ∏è Excel
                </button>
                <button onclick="document.getElementById('input-excel-importar').click()" style="background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    ‚¨ÜÔ∏è Importar
                </button>
                <button onclick="eliminarTodo()" style="background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    ‚ò¢Ô∏è Borrar Todo
                </button>
            </div>
        </div>

        <table id="tabla-cotizaciones">
            <thead>
                <tr>
                    <th class="text-center" style="width: 50px;">#</th>
                    <th class="text-center">Folio</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th class="text-center">Piezas</th>
                    <th class="text-right">Gran Total</th>
                    <th class="text-center">Estatus</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination-container" id="panel-paginacion" style="display:none;">
            <button class="btn-paginacion" id="btn-prev" onclick="cambiarPagina(-1)">‚¨ÖÔ∏è Anterior</button>
            <span class="page-info" id="lbl-page-info">Mostrando 0 - 0 de 0</span>
            <button class="btn-paginacion" id="btn-next" onclick="cambiarPagina(1)">Siguiente ‚û°Ô∏è</button>
        </div>
    </div>

   <script>
       // --- VARIABLES GLOBALES ---
       let todasLasCotizaciones = []; 
       let datosFiltrados = []; // Copia para manejar la paginaci√≥n con filtros
       let paginaActual = 1;
       const filasPorPagina = 20;

    async function cargarHistorial() {
        try {
            const respuesta = await fetch('/cotizaciones');
            let datos = await respuesta.json();

            datos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            const contadoresPorMes = {}; 
            datos = datos.map(c => {
                const fecha = new Date(c.fecha);
                if(isNaN(fecha)) return c; 
                
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                const claveMes = `${mes}-${anio}`; 
                if (!contadoresPorMes[claveMes]) contadoresPorMes[claveMes] = 0;
                contadoresPorMes[claveMes]++;
                const consecutivo = contadoresPorMes[claveMes].toString().padStart(3, '0');
                c.folioInteligente = `${consecutivo}-${mes}-${anio}`;
                return c;
            });
            datos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Asignamos datos
            todasLasCotizaciones = datos;
            datosFiltrados = datos; // Inicialmente son iguales
            
            llenarOpcionesFiltros();
            
            // Resetear paginaci√≥n y renderizar
            paginaActual = 1;
            renderizarTabla();
            
        } catch (error) { console.error(error); }
    }

    function renderizarTabla() {
        const tabla = document.querySelector('#tabla-cotizaciones tbody');
        const panelPaginacion = document.getElementById('panel-paginacion');
        
        if (datosFiltrados.length === 0) {
            tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Sin datos.</td></tr>';
            panelPaginacion.style.display = 'none';
            return;
        }

        // --- L√ìGICA DE PAGINACI√ìN ---
        panelPaginacion.style.display = 'flex';
        
        const inicio = (paginaActual - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        const datosPagina = datosFiltrados.slice(inicio, fin); // Solo tomamos 20

        tabla.innerHTML = ''; 
        
        datosPagina.forEach((c, index) => {
            // El √≠ndice visual debe ser el real, no el relativo a la p√°gina
            const indiceReal = inicio + index + 1;

            const fechaObj = new Date(c.fecha);
            const fecha = !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-MX', {day: '2-digit', month: '2-digit', year: 'numeric'}) : '-';
            
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) {
                c.items.forEach(item => { cantidadTotal += Number(item.cantidad) || 0; });
            } else {
                cantidadTotal = Number(c.cantidad) || 0; 
            }
            
            const totalFinal = c.total ? c.total : 0;
            
            const fila = `
                <tr>
                    <td class="text-center" style="color:#666;">${indiceReal}</td>
                    <td class="text-center"><span class="id-row">${c.folioInteligente || 'N/A'}</span></td>
                    <td style="font-weight: bold; color: #333;">${c.cliente}</td>
                    <td>${fecha}</td>
                    <td class="text-center">${cantidadTotal}</td>
                    <td class="text-right"><span class="total">$${totalFinal.toFixed(2)}</span></td>
                    <td class="text-center">
                        <span class="badge-status">Emitida</span>
                        <button class="btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Borrar">üóëÔ∏è</button>
                    </td>
                </tr>`;
            tabla.innerHTML += fila;
        });

        actualizarControlesPaginacion();
    }

    function actualizarControlesPaginacion() {
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const lblInfo = document.getElementById('lbl-page-info');

        const totalRegistros = datosFiltrados.length;
        const totalPaginas = Math.ceil(totalRegistros / filasPorPagina);
        
        const inicio = (paginaActual - 1) * filasPorPagina + 1;
        let fin = paginaActual * filasPorPagina;
        if(fin > totalRegistros) fin = totalRegistros;

        lblInfo.innerText = `Mostrando ${inicio} - ${fin} de ${totalRegistros}`;

        btnPrev.disabled = (paginaActual === 1);
        btnNext.disabled = (paginaActual === totalPaginas || totalPaginas === 0);
    }

    function cambiarPagina(direccion) {
        paginaActual += direccion;
        renderizarTabla();
    }

    // --- FILTROS (Actualizados para Paginaci√≥n) ---
    function aplicarFiltros() {
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;
        
        datosFiltrados = todasLasCotizaciones.filter(c => {
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;
            return coincideCliente && coincideCotizador;
        });
        
        paginaActual = 1; // Resetear a la primera p√°gina al filtrar
        renderizarTabla();
    }

    function limpiarFiltros() {
        document.getElementById('filtro-cliente').value = "";
        document.getElementById('filtro-cotizador').value = "";
        datosFiltrados = todasLasCotizaciones;
        paginaActual = 1;
        renderizarTabla();
    }

    function llenarOpcionesFiltros() {
        const selectCliente = document.getElementById('filtro-cliente');
        const selectCotizador = document.getElementById('filtro-cotizador');
        // Limpiamos y repoblamos solo una vez
        if(selectCliente.options.length > 1) return; 

        const clientesUnicos = [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort();
        const cotizadoresUnicos = [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort(); 
        clientesUnicos.forEach(cliente => selectCliente.add(new Option(cliente, cliente)));
        cotizadoresUnicos.forEach(cotizador => selectCotizador.add(new Option(cotizador, cotizador)));
    }

    // --- IMPORTACI√ìN / EXPORTACI√ìN / BORRADO (Sin cambios l√≥gicos, solo integraci√≥n) ---
    function procesarArchivoExcel(input) {
        const archivo = input.files[0];
        if (!archivo) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: false}); 
            const primerHoja = workbook.SheetNames[0];
            const hoja = workbook.Sheets[primerHoja];
            const datosExcel = XLSX.utils.sheet_to_json(hoja, { range: 1 }); 
            if(datosExcel.length === 0) { alert("Excel vac√≠o."); return; }
            const confirmar = confirm(`Se encontraron ${datosExcel.length} filas. ¬øImportar?`);
            if(!confirmar) return;
            const overlay = document.getElementById('loading-overlay');
            const progressBar = document.getElementById('progress-bar');
            const counterText = document.getElementById('counter-text');
            overlay.style.display = 'flex';
            let importados = 0; let total = datosExcel.length;
            for (let i = 0; i < total; i++) {
                let row = datosExcel[i];
                let porcentaje = Math.round(((i + 1) / total) * 100);
                progressBar.style.width = porcentaje + "%";
                counterText.innerText = `Procesando ${i + 1} de ${total}`;
                let fechaFinal = new Date();
                const fechaRaw = row['Fecha'];
                if (typeof fechaRaw === 'number') { fechaFinal = new Date((fechaRaw - (25567 + 2)) * 86400 * 1000); } 
                else if (typeof fechaRaw === 'string') { const partes = fechaRaw.split('/'); if (partes.length === 3) fechaFinal = new Date(partes[2], partes[1] - 1, partes[0]); }
                const folioExcel = row['folio'] || 'S/N';
                const objetoParaBD = {
                    cliente: row['Cliente'] || "Importado", fecha: fechaFinal, total: parseFloat(row['Total'] || 0),
                    quienCotiza: "Importado", iva: 0, items: [{ producto: `Imp. Excel (Folio: ${folioExcel})`, cantidad: parseInt(row['Piezas'] || 1), total: parseFloat(row['Total'] || 0) }], gastosAdicionales: []
                };
                try { await fetch('/cotizaciones', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(objetoParaBD) }); importados++; } catch(e) {}
            }
            overlay.style.display = 'none';
            alert(`‚úÖ Finalizado. Importados: ${importados}`);
            input.value = ''; cargarHistorial(); 
        };
        reader.readAsArrayBuffer(archivo);
    }

    async function eliminarTodo() {
        if(todasLasCotizaciones.length === 0) return alert("Nada que borrar.");
        const confirmacion = confirm("‚ö†Ô∏è ¬øELIMINAR TODO EL HISTORIAL?");
        if (!confirmacion) return;
        const password = prompt("üîí Password:");
        if (!password) return;
        const overlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const counterText = document.getElementById('counter-text');
        document.querySelector('.loader-text').innerText = "üóëÔ∏è Eliminando...";
        overlay.style.display = 'flex';
        let eliminados = 0; let total = todasLasCotizaciones.length;
        for (let i = 0; i < total; i++) {
            const cotizacion = todasLasCotizaciones[i];
            let porcentaje = Math.round(((i + 1) / total) * 100);
            progressBar.style.width = porcentaje + "%";
            counterText.innerText = `Eliminando ${i + 1} de ${total}`;
            try { await fetch('/cotizaciones', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: cotizacion._id, password: password }) }); eliminados++; } catch (error) {}
        }
        overlay.style.display = 'none';
        document.querySelector('.loader-text').innerText = "üîÑ Importando...";
        alert(`üßπ Eliminados: ${eliminados}`);
        cargarHistorial();
    }

    function exportarExcel() {
        if (datosFiltrados.length === 0) { alert("No hay datos"); return; }
        const datosFormateados = datosFiltrados.map(c => {
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) c.items.forEach(item => cantidadTotal += Number(item.cantidad) || 0);
            return { "Folio": c.folioInteligente, "Cliente": c.cliente, "Fecha": new Date(c.fecha).toLocaleDateString('es-MX'), "Cotizador": c.quienCotiza, "Piezas": cantidadTotal, "Total": c.total };
        });
        const ws = XLSX.utils.json_to_sheet(datosFormateados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Cotizaciones");
        XLSX.writeFile(wb, `Reporte_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    async function confirmarBorrado(id) {
        const password = prompt("üîí Password:");
        if (!password) return;
        try {
            const res = await fetch('/cotizaciones', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, password: password }) });
            const data = await res.json();
            if (data.exito) { alert("Eliminado"); cargarHistorial(); } else { alert(data.mensaje); }
        } catch (error) { alert("Error red"); }
    }

    cargarHistorial();
   </script>
</body>
</html>