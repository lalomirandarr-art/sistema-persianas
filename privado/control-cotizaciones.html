<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial Financiero Completo</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }
        
        /* --- TABLA --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.9em; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #001f3f; color: white; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }
        
        .total { font-weight: bold; font-size: 1.1em; color: #28a745; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .id-row { font-weight: bold; color: #001f3f; background: #eef2f5; padding: 4px 8px; border-radius: 4px; display: inline-block; font-size: 0.9em; }
        .badge-status { background-color: #e3f2fd; color: #0d47a1; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; font-weight: bold; display: inline-block; }

        /* --- BOTONES --- */
        button { cursor: pointer; transition: all 0.2s; }
        .btn-icon { background: none; border: none; font-size: 1.2em; padding: 5px; }
        .btn-ver { color: #007bff; }
        .btn-ver:hover { transform: scale(1.2); color: #0056b3; }
        .btn-borrar { color: #dc3545; }
        .btn-borrar:hover { transform: scale(1.2); color: #a71d2a; }

        /* --- PANTALLA DE CARGA --- */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .progress-container { width: 80%; max-width: 600px; background: #333; border-radius: 10px; overflow: hidden; margin-top: 20px; border: 2px solid #555; }
        .progress-bar { height: 30px; width: 0%; background: #28a745; transition: width 0.1s linear; }
        .loader-text { font-size: 1.5em; margin-bottom: 10px; }

        /* --- PAGINACI√ìN --- */
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-paginacion { background-color: #001f3f; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
        .btn-paginacion:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- MODAL DE DETALLES (NUEVO) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 900px;
            border-radius: 10px; padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #001f3f; }
        .close-modal { background: none; border: none; font-size: 2em; color: #aaa; cursor: pointer; }
        .close-modal:hover { color: #333; }

        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }
        .form-group input:read-only { background-color: #e9ecef; color: #666; }

        .financial-box {
            background-color: #f8f9fa; padding: 15px; border-radius: 8px;
            border-left: 5px solid #28a745; margin-top: 20px;
        }
        .financial-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1em; }
        .financial-total { font-size: 1.4em; font-weight: bold; color: #001f3f; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; }
        
        .items-list { margin-top: 20px; border: 1px solid #eee; padding: 10px; max-height: 150px; overflow-y: auto; background: #fff; }
        .item-row { border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em; display: flex; justify-content: space-between; }

        .btn-save { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 1.1em; width: 100%; margin-top: 20px; }
        .btn-save:hover { background-color: #218838; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-text">üîÑ Procesando...</div>
        <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div id="counter-text" class="counter-text">0 / 0</div>
    </div>

    <div id="modal-detalles" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo">Detalles de Cotizaci√≥n</h2>
                <button class="close-modal" onclick="cerrarModal()">√ó</button>
            </div>
            
            <input type="hidden" id="edit-id"> <div class="modal-grid">
                <div>
                    <div class="form-group">
                        <label>Folio:</label>
                        <input type="text" id="edit-folio" readonly>
                    </div>
                    <div class="form-group">
                        <label>Cliente:</label>
                        <input type="text" id="edit-cliente">
                    </div>
                    <div class="form-group">
                        <label>Cotizador:</label>
                        <input type="text" id="edit-cotizador" readonly>
                    </div>
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="text" id="edit-fecha" readonly>
                    </div>
                    <div class="form-group">
                        <label>Estatus:</label>
                        <select id="edit-estatus">
                            <option value="Emitida">Emitida</option>
                            <option value="Aprobada">Aprobada</option>
                            <option value="Pagada">Pagada</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label>Productos (Resumen):</label>
                        <div id="lista-items" class="items-list"></div>
                    </div>

                    <div class="financial-box">
                        <div class="financial-row"><span>Costo Aprox:</span> <span id="val-costo">$0.00</span></div>
                        <div class="financial-row"><span>Utilidad:</span> <span id="val-utilidad" style="color:green;">$0.00</span></div>
                        <hr>
                        <div class="financial-row"><span>Subtotal:</span> <input type="number" id="edit-subtotal" onchange="recalcularTotal()" style="width:100px; text-align:right;"></div>
                        <div class="financial-row"><span>Gastos Extra:</span> <input type="number" id="edit-gastos" onchange="recalcularTotal()" style="width:100px; text-align:right;"></div>
                        <div class="financial-row"><span>IVA (16%):</span> <span id="val-iva">$0.00</span></div>
                        <div class="financial-row financial-total"><span>Total Final:</span> <span id="val-total">$0.00</span></div>
                    </div>
                </div>
            </div>

            <button class="btn-save" onclick="guardarCambios()">üíæ Guardar Cambios</button>
        </div>
    </div>

    <header class="header">
        <div class="nav-container">
            <div class="logo"><img src="/IMG/logoPD.jpeg" alt="Logo"></div>
            <nav class="nav-links">
                <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
                <a href="/inicio.html">Inicio</a>
                <a href="/productos.html">Productos</a>
                <a href="/clientes.html">Clientes</a>
                <div class="dropdown">
                    <button class="dropbtn">Cotizaciones ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                        <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="historial-container">
        <h1>üìä Historial Resumido de Cotizaciones</h1>
        <input type="file" id="input-excel-importar" style="display: none;" accept=".xlsx, .xls" onchange="procesarArchivoExcel(this)">

        <div style="background-color: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1;"><label>Filtro Cliente:</label><select id="filtro-cliente" onchange="aplicarFiltros()" style="width:100%"><option value="">-- Todos --</option></select></div>
            <div style="flex: 1;"><label>Filtro Cotizador:</label><select id="filtro-cotizador" onchange="aplicarFiltros()" style="width:100%"><option value="">-- Todos --</option></select></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="limpiarFiltros()" style="background:#6c757d; color:white; border:none; padding:10px; border-radius:5px;">üîÑ Limpiar</button>
                <button onclick="exportarExcel()" style="background:#217346; color:white; border:none; padding:10px; border-radius:5px;">‚¨áÔ∏è Excel</button>
                <button onclick="document.getElementById('input-excel-importar').click()" style="background:#007bff; color:white; border:none; padding:10px; border-radius:5px;">‚¨ÜÔ∏è Importar</button>
                <button onclick="eliminarTodo()" style="background:#dc3545; color:white; border:none; padding:10px; border-radius:5px;">‚ò¢Ô∏è Borrar Todo</button>
            </div>
        </div>

        <table id="tabla-cotizaciones">
            <thead>
                <tr>
                    <th class="text-center">#</th>
                    <th class="text-center">Folio</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th class="text-center">Piezas</th>
                    <th class="text-right">Gran Total</th>
                    <th class="text-center">Estatus</th>
                    <th class="text-center">Opciones</th> </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination-container" id="panel-paginacion" style="display:none;">
            <button class="btn-paginacion" id="btn-prev" onclick="cambiarPagina(-1)">‚¨ÖÔ∏è Anterior</button>
            <span class="page-info" id="lbl-page-info">0 - 0 de 0</span>
            <button class="btn-paginacion" id="btn-next" onclick="cambiarPagina(1)">Siguiente ‚û°Ô∏è</button>
        </div>
    </div>

   <script>
       // --- VARIABLES GLOBALES ---
       let todasLasCotizaciones = []; 
       let datosFiltrados = [];
       let paginaActual = 1;
       const filasPorPagina = 20;

    async function cargarHistorial() {
        try {
            const respuesta = await fetch('/cotizaciones');
            let datos = await respuesta.json();
            
            // Asignar Folios
            datos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            const contadoresPorMes = {}; 
            datos = datos.map(c => {
                const fecha = new Date(c.fecha);
                if(isNaN(fecha)) return c; 
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                const claveMes = `${mes}-${anio}`; 
                if (!contadoresPorMes[claveMes]) contadoresPorMes[claveMes] = 0;
                contadoresPorMes[claveMes]++;
                c.folioInteligente = `${contadoresPorMes[claveMes].toString().padStart(3, '0')}-${mes}-${anio}`;
                return c;
            });
            datos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            todasLasCotizaciones = datos;
            datosFiltrados = datos;
            llenarOpcionesFiltros();
            paginaActual = 1;
            renderizarTabla();
        } catch (error) { console.error(error); }
    }

    function renderizarTabla() {
        const tabla = document.querySelector('#tabla-cotizaciones tbody');
        const panelPaginacion = document.getElementById('panel-paginacion');
        
        if (datosFiltrados.length === 0) {
            tabla.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Sin datos.</td></tr>';
            panelPaginacion.style.display = 'none';
            return;
        }

        panelPaginacion.style.display = 'flex';
        const inicio = (paginaActual - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        const datosPagina = datosFiltrados.slice(inicio, fin);

        tabla.innerHTML = ''; 
        
        datosPagina.forEach((c, index) => {
            const indiceReal = inicio + index + 1;
            const fechaObj = new Date(c.fecha);
            const fecha = !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-MX') : '-';
            
            let cantidadTotal = 0;
            if (c.items) c.items.forEach(i => cantidadTotal += Number(i.cantidad) || 0);
            
            // Si no tiene estatus, asignamos uno por defecto (visual)
            const estatus = c.estatus || "Emitida";

            const fila = `
                <tr>
                    <td class="text-center" style="color:#666;">${indiceReal}</td>
                    <td class="text-center"><span class="id-row">${c.folioInteligente || 'N/A'}</span></td>
                    <td style="font-weight: bold;">${c.cliente}</td>
                    <td>${fecha}</td>
                    <td class="text-center">${cantidadTotal}</td>
                    <td class="text-right"><span class="total">$${(c.total || 0).toFixed(2)}</span></td>
                    <td class="text-center"><span class="badge-status">${estatus}</span></td>
                    <td class="text-center">
                        <button class="btn-icon btn-ver" onclick="abrirModalDetalles('${c._id}')" title="Ver Detalles">üëÅÔ∏è</button>
                        <button class="btn-icon btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Borrar">üóëÔ∏è</button>
                    </td>
                </tr>`;
            tabla.innerHTML += fila;
        });
        actualizarControlesPaginacion();
    }

    // --- L√ìGICA DEL MODAL (VER Y EDITAR) ---
    function abrirModalDetalles(id) {
        const c = todasLasCotizaciones.find(item => item._id === id);
        if(!c) return;

        // 1. Llenar campos
        document.getElementById('edit-id').value = c._id;
        document.getElementById('modal-titulo').innerText = `Detalles: ${c.folioInteligente}`;
        document.getElementById('edit-folio').value = c.folioInteligente;
        document.getElementById('edit-cliente').value = c.cliente;
        document.getElementById('edit-cotizador').value = c.quienCotiza || 'N/A';
        document.getElementById('edit-fecha').value = new Date(c.fecha).toLocaleString();
        document.getElementById('edit-estatus').value = c.estatus || 'Emitida';

        // 2. Calcular Financieros (Estimaci√≥n si es importado)
        let total = c.total || 0;
        let gastos = c.totalGastosAdicionales || 0;
        let iva = c.iva || 0;
        
        // Si es importado y no tiene subtotal desglosado, hacemos ingenier√≠a inversa b√°sica
        let subtotal = total - iva - gastos;
        if(subtotal < 0) subtotal = total; 

        document.getElementById('edit-subtotal').value = subtotal.toFixed(2);
        document.getElementById('edit-gastos').value = gastos.toFixed(2);
        
        // Calcular Costo y Utilidad (Basado en datos guardados si existen)
        let costoTotal = 0;
        const listaItems = document.getElementById('lista-items');
        listaItems.innerHTML = '';

        if(c.items && c.items.length > 0) {
            c.items.forEach(item => {
                // Intentar obtener costo base si existe (cotizaciones nuevas)
                let costoItem = 0;
                if(item.financiero && item.financiero.costoBase) {
                    costoItem = item.financiero.costoBase; // Unitario
                    costoTotal += (costoItem * item.cantidad); // Total costo linea
                }
                // Si es importado, el costo es desconocido (0) a menos que lo editemos.
                
                listaItems.innerHTML += `
                    <div class="item-row">
                        <span>${item.cantidad}x ${item.producto}</span>
                        <strong>$${(item.total || 0).toFixed(2)}</strong>
                    </div>
                `;
            });
        }
        
        // Mostrar Costo y Utilidad
        document.getElementById('val-costo').innerText = `$${costoTotal.toFixed(2)}`;
        recalcularTotal(); // Esto actualiza los labels de totales y utilidad final

        // 3. Mostrar Modal
        document.getElementById('modal-detalles').style.display = 'flex';
    }

    function recalcularTotal() {
        // Obtiene valores de los inputs editables
        const sub = parseFloat(document.getElementById('edit-subtotal').value) || 0;
        const gas = parseFloat(document.getElementById('edit-gastos').value) || 0;
        
        // Asumimos IVA 16% del subtotal + gastos (Regla de negocio est√°ndar)
        // OJO: Si tus importados no tienen IVA, esto lo calcular√°.
        // Si prefieres que el IVA sea fijo, habr√≠a que poner un input para el IVA tambi√©n.
        const iva = (sub + gas) * 0.16;
        const total = sub + gas + iva;

        // Recuperar costo calculado antes (o 0 si es importado)
        const txtCosto = document.getElementById('val-costo').innerText.replace('$','');
        const costo = parseFloat(txtCosto) || 0;
        const utilidad = (sub + gas) - costo; // Utilidad antes de impuestos o neta seg√∫n tu l√≥gica. Aqu√≠ uso (Venta sin IVA - Costo)

        // Actualizar UI
        document.getElementById('val-iva').innerText = `$${iva.toFixed(2)}`;
        document.getElementById('val-total').innerText = `$${total.toFixed(2)}`;
        
        const lblUtil = document.getElementById('val-utilidad');
        lblUtil.innerText = `$${utilidad.toFixed(2)}`;
        lblUtil.style.color = utilidad >= 0 ? 'green' : 'red';
    }

    async function guardarCambios() {
        const id = document.getElementById('edit-id').value;
        const cliente = document.getElementById('edit-cliente').value;
        const estatus = document.getElementById('edit-estatus').value;
        
        // Recalcular num√©ricamente para enviar limpio
        const sub = parseFloat(document.getElementById('edit-subtotal').value) || 0;
        const gas = parseFloat(document.getElementById('edit-gastos').value) || 0;
        const iva = (sub + gas) * 0.16;
        const total = sub + gas + iva;

        const datosUpdate = {
            id: id,
            cliente: cliente,
            estatus: estatus,
            total: total,
            iva: iva,
            totalGastosAdicionales: gas
            // Nota: No estamos actualizando los items individuales aqu√≠, solo totales y cabecera
        };

        try {
            const res = await fetch('/cotizaciones', {
                method: 'PUT', // Aseg√∫rate de tener este endpoint en tu servidor Node
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(datosUpdate)
            });
            
            const r = await res.json();
            if(r.exito) {
                alert("‚úÖ Cambios guardados correctamente.");
                cerrarModal();
                cargarHistorial(); // Recargar tabla
            } else {
                alert("Error al guardar: " + (r.mensaje || "Desconocido"));
                // Fallback si no tienes endpoint PUT: Simulamos en local para demo
                // (Borra esto si ya tienes el backend)
                // alert("Nota: Necesitas configurar la ruta app.put('/cotizaciones') en tu servidor.");
            }
        } catch(e) { console.error(e); alert("Error de conexi√≥n"); }
    }

    function cerrarModal() {
        document.getElementById('modal-detalles').style.display = 'none';
    }

    // --- (RESTO DE FUNCIONES IGUALES: PAGINACI√ìN, EXCEL, ETC) ---
    function actualizarControlesPaginacion() {
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const lblInfo = document.getElementById('lbl-page-info');
        const totalRegistros = datosFiltrados.length;
        const totalPaginas = Math.ceil(totalRegistros / filasPorPagina);
        const inicio = (paginaActual - 1) * filasPorPagina + 1;
        let fin = paginaActual * filasPorPagina;
        if(fin > totalRegistros) fin = totalRegistros;
        lblInfo.innerText = `Mostrando ${inicio} - ${fin} de ${totalRegistros}`;
        btnPrev.disabled = (paginaActual === 1);
        btnNext.disabled = (paginaActual === totalPaginas || totalPaginas === 0);
    }
    function cambiarPagina(dir) { paginaActual += dir; renderizarTabla(); }
    function aplicarFiltros() { 
        const cli = document.getElementById('filtro-cliente').value;
        const cot = document.getElementById('filtro-cotizador').value;
        datosFiltrados = todasLasCotizaciones.filter(c => (cli ? c.cliente === cli : true) && (cot ? c.quienCotiza === cot : true));
        paginaActual = 1; renderizarTabla(); 
    }
    function limpiarFiltros() { 
        document.getElementById('filtro-cliente').value = ""; document.getElementById('filtro-cotizador').value = "";
        datosFiltrados = todasLasCotizaciones; paginaActual = 1; renderizarTabla(); 
    }
    function llenarOpcionesFiltros() {
        const selCli = document.getElementById('filtro-cliente'); const selCot = document.getElementById('filtro-cotizador');
        if(selCli.options.length > 1) return;
        [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort().forEach(x => selCli.add(new Option(x, x)));
        [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort().forEach(x => selCot.add(new Option(x, x)));
    }
    // IMPORTAR/EXPORTAR IGUAL QUE ANTES (Resumido para ahorrar espacio, el tuyo anterior sirve)
    function procesarArchivoExcel(input) {
        // ... (Usa tu funci√≥n procesarArchivoExcel anterior, funciona igual) ...
        const archivo = input.files[0]; if (!archivo) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: false}); 
            const hoja = workbook.Sheets[workbook.SheetNames[0]];
            const datosExcel = XLSX.utils.sheet_to_json(hoja, { range: 1 });
            if(datosExcel.length===0) return alert("Vac√≠o");
            if(!confirm(`Importar ${datosExcel.length}?`)) return;
            document.getElementById('loading-overlay').style.display='flex';
            let ok=0;
            for(let row of datosExcel) {
                // ... L√≥gica de fecha y objeto ... (Copia tu l√≥gica aqu√≠)
                 let fechaFinal = new Date(); const fechaRaw = row['Fecha'];
                 if (typeof fechaRaw === 'number') fechaFinal = new Date((fechaRaw - 25569)*86400*1000);
                 else if (typeof fechaRaw === 'string') { const p = fechaRaw.split('/'); if(p.length===3) fechaFinal=new Date(p[2],p[1]-1,p[0]); }
                 const obj = { cliente: row['Cliente']||"Imp", fecha: fechaFinal, total: row['Total']||0, quienCotiza:"Importado", items:[{cantidad:row['Piezas']||1, total:row['Total']||0}] };
                 try { await fetch('/cotizaciones', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)}); ok++; } catch(e){}
            }
            document.getElementById('loading-overlay').style.display='none';
            alert(`Imp: ${ok}`); input.value=''; cargarHistorial();
        }; reader.readAsArrayBuffer(archivo);
    }
    function exportarExcel() { /* ... tu l√≥gica de exportar ... */ }
    async function eliminarTodo() { /* ... tu l√≥gica de eliminar ... */ }
    async function confirmarBorrado(id) { /* ... tu l√≥gica de borrar uno ... */ }

    cargarHistorial();
   </script>
</body>
</html>