<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial Financiero Completo</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.9em; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #001f3f; color: white; }
        tr:hover { background-color: #f8f9fa; }
        
        .fecha { color: #666; font-size: 0.9em; display: block; margin-top: 4px;}
        .total { font-weight: bold; font-size: 1.1em; color: #000; }

        /* Estilo del Bot√≥n Borrar */
        .btn-borrar {
            background-color: transparent; border: 1px solid #dc3545; color: #dc3545;
            padding: 4px 8px; border-radius: 5px; cursor: pointer; transition: all 0.3s;
            margin-left: 10px; font-size: 0.8em;
        }
        .btn-borrar:hover { background-color: #dc3545; color: white; }
        
        /* Centrado de columnas espec√≠ficas */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* Estilo para el ID (Folio) */
        .id-row { 
            font-weight: bold; 
            color: #001f3f; 
            background: #eef2f5; 
            padding: 5px 10px; 
            border-radius: 4px; 
            display: inline-block;
            min-width: 90px; 
            text-align: center;
        }
    </style>
</head>
<body>

    <header class="header">
    <div class="nav-container">
        <div class="logo">
            <img src="/IMG/logoPD.jpeg" alt="Logo">
        </div>
        
        <nav class="nav-links">
            <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
            <a href="/inicio.html">Inicio</a>
            <a href="/productos.html">Productos</a>
            <a href="/clientes.html">Clientes</a>
            
            <div class="dropdown">
                <button class="dropbtn">Cotizaciones ‚ñº</button>
                <div class="dropdown-content">
                    <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                    <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                </div>
            </div>
        </nav>
    </div>
    </header>

    <div class="historial-container">
        <h1>üìä Historial Resumido de Cotizaciones</h1>
        
        <div style="background-color: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üë§ Filtrar por Cliente:</label>
                <select id="filtro-cliente" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üõ†Ô∏è Filtrar por Cotizador:</label>
                <select id="filtro-cotizador" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 0; display: flex; gap: 10px;">
                <button onclick="limpiarFiltros()" style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Limpiar
                </button>
                <button onclick="exportarExcel()" style="background-color: #217346; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    üìÇ Excel
                </button>
            </div>
        </div>

        <table id="tabla-cotizaciones">
            <thead>
                <tr>
                    <th style="width: 120px;" class="text-center">Folio</th>
                    <th>Cliente / Fecha</th>
                    <th>Cotizador</th>
                    <th class="text-center">Cant. Persianas</th>
                    <th class="text-right">Gran Total</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

   <script>
       let todasLasCotizaciones = []; 

    // 1. CARGAR DATOS Y CALCULAR FOLIOS
    async function cargarHistorial() {
        try {
            const respuesta = await fetch('/cotizaciones');
            let datos = await respuesta.json();

            // ORDENAR POR FECHA (M√°s antigua primero para calcular folios)
            datos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            // CALCULAR FOLIOS INTELIGENTES
            const contadoresPorMes = {}; 

            datos = datos.map(c => {
                const fecha = new Date(c.fecha);
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                const claveMes = `${mes}-${anio}`; 

                if (!contadoresPorMes[claveMes]) {
                    contadoresPorMes[claveMes] = 0;
                }
                contadoresPorMes[claveMes]++;

                const consecutivo = contadoresPorMes[claveMes].toString().padStart(3, '0');
                
                c.folioInteligente = `${consecutivo}-${mes}-${anio}`;
                return c;
            });

            // RE-ORDENAR (M√°s reciente primero) para mostrar
            datos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            todasLasCotizaciones = datos;
            
            llenarOpcionesFiltros();
            renderizarTabla(todasLasCotizaciones);
        } catch (error) {
            console.error(error);
            alert("Error al cargar historial (Revisa la consola para m√°s detalles).");
        }
    }

    // 2. DIBUJAR LA TABLA
    function renderizarTabla(datos) {
        const tabla = document.querySelector('#tabla-cotizaciones tbody');
        
        if (datos.length === 0) {
            tabla.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #666;">No se encontraron coincidencias.</td></tr>';
            return;
        }

        tabla.innerHTML = ''; 
        
        datos.forEach((c) => {
            const fecha = new Date(c.fecha).toLocaleDateString('es-MX', { 
                month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' 
            });

            const cotizador = c.quienCotiza ? c.quienCotiza : '<span style="color:#ccc;">---</span>';
            
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) {
                c.items.forEach(item => { cantidadTotal += Number(item.cantidad) || 0; });
            } else {
                cantidadTotal = Number(c.cantidad) || 0;
            }

            const totalFinal = c.total ? c.total : 0;
            let infoIVA = c.iva && c.iva > 0 ? '(c/IVA)' : '';

            const fila = `
                <tr>
                    <td class="text-center">
                        <span class="id-row">${c.folioInteligente}</span>
                    </td>
                    <td>
                        <strong>${c.cliente}</strong>
                        <span class="fecha">${fecha}</span>
                    </td>
                    <td style="color: #007bff; font-weight: 500;">${cotizador}</td>
                    <td class="text-center" style="font-size: 1.1em;">
                        ${cantidadTotal} pzas
                    </td>
                    <td class="text-right">
                        <span class="total">$${totalFinal.toFixed(2)}</span> <small>${infoIVA}</small>
                        <button class="btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Eliminar Cotizaci√≥n">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
            tabla.innerHTML += fila;
        });
    }

    // 3. LLENAR SELECTS
    function llenarOpcionesFiltros() {
        const selectCliente = document.getElementById('filtro-cliente');
        const selectCotizador = document.getElementById('filtro-cotizador');

        const clientesUnicos = [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort();
        const cotizadoresUnicos = [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort(); 

        clientesUnicos.forEach(cliente => {
            selectCliente.add(new Option(cliente, cliente));
        });
        cotizadoresUnicos.forEach(cotizador => {
            selectCotizador.add(new Option(cotizador, cotizador));
        });
    }

    // 4. APLICAR FILTROS
    function aplicarFiltros() {
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;

        const listaFiltrada = todasLasCotizaciones.filter(c => {
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;
            return coincideCliente && coincideCotizador;
        });
        renderizarTabla(listaFiltrada);
    }

    // 5. LIMPIAR
    function limpiarFiltros() {
        document.getElementById('filtro-cliente').value = "";
        document.getElementById('filtro-cotizador').value = "";
        renderizarTabla(todasLasCotizaciones);
    }

    // 6. FUNCI√ìN EXPORTAR A EXCEL (NUEVA)
    function exportarExcel() {
        // Obtenemos los filtros actuales para solo exportar lo que el usuario est√° viendo
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;

        // Filtramos de nuevo (igual que en aplicarFiltros)
        const listaParaExcel = todasLasCotizaciones.filter(c => {
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;
            return coincideCliente && coincideCotizador;
        });

        if (listaParaExcel.length === 0) {
            alert("No hay datos para exportar");
            return;
        }

        // Mapeamos los datos para que en Excel salgan las columnas limpias
        const datosFormateados = listaParaExcel.map(c => {
            // Calcular cantidad total de items
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) {
                c.items.forEach(item => { cantidadTotal += Number(item.cantidad) || 0; });
            }

            return {
                "Folio": c.folioInteligente,
                "Cliente": c.cliente,
                "Fecha": new Date(c.fecha).toLocaleDateString('es-MX'),
                "Cotizador": c.quienCotiza || "N/A",
                "Cant. Persianas": cantidadTotal,
                "Total ($)": c.total || 0,
                "IVA Incluido": (c.iva && c.iva > 0) ? "S√≠" : "No"
            };
        });

        // Crear hoja de trabajo y libro
        const worksheet = XLSX.utils.json_to_sheet(datosFormateados);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Cotizaciones");

        // Generar nombre de archivo con fecha
        const fechaHoy = new Date().toISOString().split('T')[0];
        XLSX.writeFile(workbook, `Reporte_Cotizaciones_${fechaHoy}.xlsx`);
    }

    // BORRAR
    async function confirmarBorrado(id) {
        const password = prompt("üîí ACCESO RESTRINGIDO\nPara eliminar esta cotizaci√≥n, ingresa la contrase√±a de administrador:");
        if (!password) return;

        try {
            const res = await fetch('/cotizaciones', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, password: password })
            });
            const data = await res.json();
            if (data.exito) {
                alert("‚úÖ " + data.mensaje);
                cargarHistorial(); 
            } else {
                alert("‚õî Error: " + data.mensaje); 
            }
        } catch (error) {
            alert("Error de conexi√≥n con el servidor.");
        }
    }

    cargarHistorial();
   </script>
</body>
</html>