<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial Financiero Completo</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.9em; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #001f3f; color: white; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        
        .total { font-weight: bold; font-size: 1.1em; color: #28a745; }

        /* Bot√≥n Borrar m√°s discreto */
        .btn-borrar {
            background-color: transparent; border: none; color: #dc3545;
            font-size: 1.1em; cursor: pointer; transition: transform 0.2s;
            margin-left: 10px;
        }
        .btn-borrar:hover { transform: scale(1.2); }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* Estilo para el Folio */
        .id-row { 
            font-weight: bold; color: #001f3f; background: #eef2f5; 
            padding: 4px 8px; border-radius: 4px; display: inline-block;
            font-size: 0.9em;
        }

        /* Estilo para la nueva columna Estatus */
        .badge-status {
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body>

    <header class="header">
    <div class="nav-container">
        <div class="logo"><img src="/IMG/logoPD.jpeg" alt="Logo"></div>
        <nav class="nav-links">
            <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
            <a href="/inicio.html">Inicio</a>
            <a href="/productos.html">Productos</a>
            <a href="/clientes.html">Clientes</a>
            <div class="dropdown">
                <button class="dropbtn">Cotizaciones ‚ñº</button>
                <div class="dropdown-content">
                    <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                    <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                </div>
            </div>
        </nav>
    </div>
    </header>

    <div class="historial-container">
        <h1>üìä Historial Resumido de Cotizaciones</h1>
        
        <input type="file" id="input-excel-importar" style="display: none;" accept=".xlsx, .xls" onchange="procesarArchivoExcel(this)">

        <div style="background-color: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üë§ Filtrar por Cliente:</label>
                <select id="filtro-cliente" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">üõ†Ô∏è Filtrar por Cotizador:</label>
                <select id="filtro-cotizador" onchange="aplicarFiltros()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">-- Ver Todos --</option>
                </select>
            </div>
            <div style="flex: 0; display: flex; gap: 10px;">
                <button onclick="limpiarFiltros()" style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Limpiar
                </button>
                <button onclick="exportarExcel()" style="background-color: #217346; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    ‚¨áÔ∏è Excel
                </button>
                <button onclick="document.getElementById('input-excel-importar').click()" style="background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    ‚¨ÜÔ∏è Importar
                </button>
            </div>
        </div>

        <table id="tabla-cotizaciones">
            <thead>
                <tr>
                    <th class="text-center" style="width: 50px;">#</th>
                    <th class="text-center">Folio</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th class="text-center">Piezas</th>
                    <th class="text-right">Gran Total</th>
                    <th class="text-center">Estatus</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

   <script>
       let todasLasCotizaciones = []; 

    async function cargarHistorial() {
        try {
            const respuesta = await fetch('/cotizaciones');
            let datos = await respuesta.json();

            // ORDENAR DATOS: 
            // Esto asegura que al asignar folios, se respete el orden cronol√≥gico
            datos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            // GENERAR FOLIOS INTELIGENTES (Consecutivo-Mes-A√±o)
            const contadoresPorMes = {}; 
            datos = datos.map(c => {
                const fecha = new Date(c.fecha);
                if(isNaN(fecha)) return c; 
                
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                const claveMes = `${mes}-${anio}`; 
                
                if (!contadoresPorMes[claveMes]) contadoresPorMes[claveMes] = 0;
                contadoresPorMes[claveMes]++;
                
                const consecutivo = contadoresPorMes[claveMes].toString().padStart(3, '0');
                c.folioInteligente = `${consecutivo}-${mes}-${anio}`;
                return c;
            });

            // REVERTIR ORDEN: Para que el usuario vea lo m√°s reciente arriba
            datos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            todasLasCotizaciones = datos;
            
            llenarOpcionesFiltros();
            renderizarTabla(todasLasCotizaciones);
        } catch (error) { console.error(error); }
    }

    function renderizarTabla(datos) {
        const tabla = document.querySelector('#tabla-cotizaciones tbody');
        
        if (datos.length === 0) {
            tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Sin datos.</td></tr>';
            return;
        }

        tabla.innerHTML = ''; 
        
        datos.forEach((c, index) => {
            const fechaObj = new Date(c.fecha);
            const fecha = !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-MX') : '-';
            
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) {
                c.items.forEach(item => { cantidadTotal += Number(item.cantidad) || 0; });
            } else {
                cantidadTotal = Number(c.cantidad) || 0; 
            }
            
            const totalFinal = c.total ? c.total : 0;
            
            // Renderizado de las 7 columnas
            const fila = `
                <tr>
                    <td class="text-center" style="color:#666;">${index + 1}</td>
                    <td class="text-center"><span class="id-row">${c.folioInteligente || 'N/A'}</span></td>
                    <td style="font-weight: bold; color: #333;">${c.cliente}</td>
                    <td>${fecha}</td>
                    <td class="text-center">${cantidadTotal}</td>
                    <td class="text-right"><span class="total">$${totalFinal.toFixed(2)}</span></td>
                    <td class="text-center">
                        <span class="badge-status">Emitida</span>
                        <button class="btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Borrar">üóëÔ∏è</button>
                    </td>
                </tr>`;
            tabla.innerHTML += fila;
        });
    }

    // --- FUNCI√ìN DE IMPORTACI√ìN AJUSTADA A TU EXCEL ---
    function procesarArchivoExcel(input) {
        const archivo = input.files[0];
        if (!archivo) return;

        const reader = new FileReader();
        
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            // cellDates: true es VITAL para que la fecha '04/12/2025' se lea bien
            const workbook = XLSX.read(data, {type: 'array', cellDates: true}); 
            
            const primerHoja = workbook.SheetNames[0];
            const hoja = workbook.Sheets[primerHoja];
            
            // --- CORRECCI√ìN CLAVE: RANGE: 1 ---
            // Como tu fila 1 dice "Cotizaciones", le decimos que empiece a leer desde la fila 2 (√≠ndice 1)
            // para que detecte "folio", "Cliente", "Fecha", etc. como encabezados.
            const datosExcel = XLSX.utils.sheet_to_json(hoja, { range: 1 });
            
            if(datosExcel.length === 0) { alert("No se encontraron datos (Revisa que los encabezados est√©n en la fila 2)."); return; }

            const confirmar = confirm(`Se encontraron ${datosExcel.length} filas. ¬øImportar ahora?`);
            if(!confirmar) return;

            let importados = 0;
            let errores = 0;

            for (let row of datosExcel) {
                // --- MAPEO EXACTO DE TUS COLUMNAS ---
                // Izquierda: Nombre en base de datos || Derecha: Nombre EXACTO en tu Excel
                
                const folioExcel = row['folio'] || 'S/N'; // 'folio' en min√∫scula seg√∫n tu imagen
                
                const objetoParaBD = {
                    cliente: row['Cliente'] || "Cliente Desconocido", // Columna C
                    fecha: row['Fecha'] || new Date(),                // Columna D
                    total: parseFloat(row['Total'] || 0),             // Columna F
                    
                    // Como NO tienes columna Cotizador, ponemos "Importado" o lo dejamos vac√≠o
                    quienCotiza: "Importado", 
                    
                    iva: 0, 
                    
                    items: [
                        {
                            // Guardamos el folio antiguo en el nombre del producto para referencia
                            producto: `Imp. Excel (Folio: ${folioExcel})`, 
                            cantidad: parseInt(row['Piezas'] || 1),   // Columna E
                            total: parseFloat(row['Total'] || 0)
                        }
                    ],
                    gastosAdicionales: []
                };

                // Enviamos al servidor
                try {
                    const res = await fetch('/cotizaciones', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(objetoParaBD)
                    });
                    if(res.ok) importados++;
                    else errores++;
                } catch(e) { errores++; }
            }

            alert(`Resumen de Importaci√≥n:\n‚úÖ √âxito: ${importados}\n‚ùå Fallos: ${errores}`);
            input.value = ''; 
            cargarHistorial(); 
        };

        reader.readAsArrayBuffer(archivo);
    }

    // (El resto de funciones auxiliares se mantienen igual: llenarFiltros, exportarExcel, etc.)
    function llenarOpcionesFiltros() {
        const selectCliente = document.getElementById('filtro-cliente');
        const selectCotizador = document.getElementById('filtro-cotizador');
        selectCliente.innerHTML = '<option value="">-- Ver Todos --</option>';
        selectCotizador.innerHTML = '<option value="">-- Ver Todos --</option>';

        const clientesUnicos = [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort();
        const cotizadoresUnicos = [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort(); 

        clientesUnicos.forEach(cliente => selectCliente.add(new Option(cliente, cliente)));
        cotizadoresUnicos.forEach(cotizador => selectCotizador.add(new Option(cotizador, cotizador)));
    }

    function aplicarFiltros() {
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;
        const listaFiltrada = todasLasCotizaciones.filter(c => {
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;
            return coincideCliente && coincideCotizador;
        });
        renderizarTabla(listaFiltrada);
    }

    function limpiarFiltros() {
        document.getElementById('filtro-cliente').value = "";
        document.getElementById('filtro-cotizador').value = "";
        renderizarTabla(todasLasCotizaciones);
    }

    function exportarExcel() {
        const clienteSeleccionado = document.getElementById('filtro-cliente').value;
        const cotizadorSeleccionado = document.getElementById('filtro-cotizador').value;
        const listaParaExcel = todasLasCotizaciones.filter(c => {
            const coincideCliente = clienteSeleccionado ? c.cliente === clienteSeleccionado : true;
            const coincideCotizador = cotizadorSeleccionado ? c.quienCotiza === cotizadorSeleccionado : true;
            return coincideCliente && coincideCotizador;
        });

        if (listaParaExcel.length === 0) { alert("No hay datos"); return; }
        const datosFormateados = listaParaExcel.map(c => {
            let cantidadTotal = 0;
            if (c.items && c.items.length > 0) c.items.forEach(item => cantidadTotal += Number(item.cantidad) || 0);
            return {
                "Folio": c.folioInteligente, "Cliente": c.cliente, "Fecha": new Date(c.fecha).toLocaleDateString('es-MX'),
                "Cotizador": c.quienCotiza, "Piezas": cantidadTotal, "Total": c.total
            };
        });
        const ws = XLSX.utils.json_to_sheet(datosFormateados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Cotizaciones");
        XLSX.writeFile(wb, `Reporte_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    async function confirmarBorrado(id) {
        const password = prompt("üîí Admin Password:");
        if (!password) return;
        try {
            const res = await fetch('/cotizaciones', {
                method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, password: password })
            });
            const data = await res.json();
            if (data.exito) { alert("Eliminado"); cargarHistorial(); } 
            else { alert(data.mensaje); }
        } catch (error) { alert("Error red"); }
    }

    cargarHistorial();
   </script>
</body>
</html>