<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Historial Financiero Completo</title>

    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>



    <style>

        /* --- ESTILOS GENERALES --- */

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }

        .historial-container { padding: 40px; max-width: 1400px; margin: auto; }

       

        /* --- TABLA --- */

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 0.9em; border-radius: 8px; overflow: hidden; }

        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }

        th { background-color: #001f3f; color: white; white-space: nowrap; }

        tr:hover { background-color: #f1f5f9; }

       /* --- ESTILOS PARA PESTA√ëAS DEL MODAL --- */
.tab-btn {
    background: none;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 1em;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
    font-weight: bold;
}

.tab-btn:hover {
    color: #001f3f;
    background-color: #e9ecef;
    border-radius: 5px 5px 0 0;
}

.tab-btn.active {
    color: #001f3f;
    border-bottom: 3px solid #001f3f;
}

.tab-content {
    /* Por defecto ocultos, JS los activa */
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

        .total { font-weight: bold; font-size: 1.1em; color: #28a745; }

        .text-center { text-align: center; }

        .text-right { text-align: right; }

       

        .id-row { font-weight: bold; color: #001f3f; background: #eef2f5; padding: 4px 8px; border-radius: 4px; display: inline-block; font-size: 0.9em; }

        .badge-status { background-color: #e3f2fd; color: #0d47a1; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; font-weight: bold; display: inline-block; }



        /* --- BOTONES --- */

        button { cursor: pointer; transition: all 0.2s; }

        .btn-icon { background: none; border: none; font-size: 1.2em; padding: 5px; margin: 0 2px; }

        .btn-ver { color: #007bff; } .btn-ver:hover { transform: scale(1.2); color: #0056b3; }

        .btn-borrar { color: #dc3545; } .btn-borrar:hover { transform: scale(1.2); color: #a71d2a; }

        .btn-pdf { color: #b02a37; } .btn-pdf:hover { transform: scale(1.2); color: #dc3545; }

        .btn-editar { color: #28a745; } .btn-editar:hover { transform: scale(1.2); color: #218838; }



        /* --- PANTALLA DE CARGA --- */

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }

        .progress-container { width: 80%; max-width: 600px; background: #333; border-radius: 10px; overflow: hidden; margin-top: 20px; border: 2px solid #555; }

        .progress-bar { height: 30px; width: 0%; background: #28a745; transition: width 0.1s linear; }

        .loader-text { font-size: 1.5em; margin-bottom: 10px; }

        .counter-text { font-size: 1.2em; color: #aaa; margin-top: 5px; }



        /* --- PAGINACI√ìN --- */

        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .btn-paginacion { background-color: #001f3f; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }

        .btn-paginacion:disabled { background-color: #ccc; cursor: not-allowed; }



        /* --- MODAL --- */

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }

        .modal-content { background: white; width: 90%; max-width: 900px; border-radius: 10px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }

        .close-modal { background: none; border: none; font-size: 2em; color: #aaa; cursor: pointer; }

        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .form-group { margin-bottom: 15px; }

        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }

        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }

        .financial-box { background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; }

        .financial-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1em; }

        .items-list { margin-top: 20px; border: 1px solid #eee; padding: 10px; max-height: 150px; overflow-y: auto; background: #fff; }

        .item-row { border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em; display: flex; justify-content: space-between; }

        .btn-save { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 1.1em; width: 100%; margin-top: 20px; }

/* --- ESTILOS DEL PANEL DE CONTROL (MEJORADO) --- */
.controls-panel {
    background-color: #f1f3f5;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-end;
    width: 100%; /* Ocupar todo el ancho disponible */
    box-sizing: border-box; /* Para que el padding no deforme el ancho */
}

.filter-item {
    flex: 1;
    min-width: 200px;
}

.filter-item select {
    width: 100%;
    box-sizing: border-box;
}

.actions-group {
    display: flex;
    gap: 10px;
    flex: 1; /* Para que los botones intenten llenar espacio si sobra */
    justify-content: flex-end; /* Alineados a la derecha en PC */
}

.btn-control {
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}
.btn-gray { background: #6c757d; }
.btn-green { background: #217346; }
.btn-blue { background: #007bff; }
.btn-red { background: #dc3545; }

/* --- NUEVO: CONTENEDOR PARA QUE LA TABLA NO ROMPA EL DISE√ëO --- */
.table-responsive {
    width: 100%;
    overflow-x: auto; /* Permite deslizar si la tabla es muy ancha */
    -webkit-overflow-scrolling: touch; /* Deslizamiento suave en iPhone */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background: white;
}

/* --- ESTILOS M√ìVILES --- */
@media (max-width: 768px) {
    .historial-container {
        padding: 10px; /* Menos margen en celular */
        width: 100%;
        box-sizing: border-box;
    }

    .controls-panel {
        flex-direction: column; /* Uno debajo del otro */
        align-items: stretch;   /* Estirar al ancho completo */
        padding: 15px;
        gap: 15px;
    }

    .filter-item {
        width: 100%;
        min-width: 0;
    }

    .actions-group {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Cuadr√≠cula 2x2 */
        gap: 10px;
    }
    
    .btn-control {
        width: 100%; /* Botones anchos */
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 12px; /* Botones m√°s altos para el dedo */
    }

    /* Ajuste para que la tabla ocupe el 100% visual sin forzar zoom */
    table {
        margin-top: 0;
        box-shadow: none; /* La sombra la tiene el contenedor ahora */
        width: 100%; 
        white-space: nowrap; /* Evita que el texto de la tabla se parta feo */
    }

    /* --- ARREGLO DEL MODAL EN CELULAR --- */
    
    /* 1. Cambiamos de 2 columnas a 1 columna */
    .modal-grid {
        grid-template-columns: 1fr; 
        gap: 10px; /* Menos espacio entre elementos */
    }

    /* 2. Ajustamos la caja blanca del modal */
    .modal-content {
        padding: 15px; /* Reducimos el relleno (antes era 30px) */
        width: 95%;    /* Que ocupe casi todo el ancho de la pantalla */
        max-height: 85vh; /* Asegura que no sea m√°s alto que la pantalla */
    }

    /* 3. Ajustamos el t√≠tulo para que no choque con la X de cerrar */
    .modal-header h2 {
        font-size: 1.3em;
        margin: 0;
    }

    /* 4. Hacemos que la caja de totales (verde) se destaque mejor */
    .financial-box {
        margin-top: 15px;
        padding: 10px;
    }

}
/* --- ESTILOS RESPONSIVOS PARA CONTABILIDAD --- */

/* 1. La cuadr√≠cula de arriba (Total, Pagado, Restante) */
.conta-resumen-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr; /* 3 columnas en PC */
    gap: 15px;
    margin-bottom: 25px;
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
}

/* 2. El formulario de nuevo pago */
.conta-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr; /* 3 columnas en PC */
    gap: 15px;
    align-items: end;
}

/* 3. Contenedor del input monto + bot√≥n */
.conta-monto-group {
    display: flex;
    gap: 10px;
}

/* --- VERSI√ìN M√ìVIL (Aqu√≠ ocurre la magia) --- */
@media (max-width: 768px) {
    /* Hacemos que los cuadros de resumen se pongan uno debajo de otro */
    .conta-resumen-grid {
        grid-template-columns: 1fr; 
        gap: 10px;
    }

    /* El formulario de pago tambi√©n se pone vertical */
    .conta-form-grid {
        grid-template-columns: 1fr;
    }

    /* El select de tipo de pago que ocupe todo el ancho */
    #pago-tipo {
        width: 100%;
    }

    /* El bot√≥n de registrar se hace grande y f√°cil de tocar */
    .conta-monto-group {
        flex-direction: column; /* Bot√≥n debajo del input */
    }
    .conta-monto-group button {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
    }
}


/* Agrega esto en tu bloque de estilos */
.btn-orden { color: #fd7e14; } /* Color naranja para diferenciarlo */
.btn-orden:hover { transform: scale(1.2); color: #e8590c; }

    </style>

</head>

<body>



    <div id="loading-overlay"><div class="loader-text">üîÑ Procesando...</div><div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div><div id="counter-text" class="counter-text">0 / 0</div></div>

   <div id="modal-detalles" class="modal-overlay">

    <div class="modal-content" style="padding: 0;"> <div class="modal-tabs-header" style="display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 10px 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="tab-btn active" onclick="cambiarPestana('detalles')">üìã Detalles</button>
            <button class="tab-btn" onclick="cambiarPestana('contabilidad')">üí∞ Contabilidad</button>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
             <h2 id="modal-titulo" style="margin: 0; font-size: 1.2em; color: #001f3f;">Detalles</h2>
             <button class="close-modal" onclick="cerrarModal()" style="font-size: 1.8em; line-height: 1;">√ó</button>
        </div>
    </div>

    <input type="hidden" id="edit-id">

    <div style="padding: 20px;">
        
        <div id="tab-detalles" class="tab-content active">
            <div class="modal-grid">
                <div>
                    <div class="form-group"><label>Folio:</label><input type="text" id="edit-folio" readonly></div>
                    <div class="form-group"><label>Cliente:</label><input type="text" id="edit-cliente"></div>
                    <div class="form-group"><label>Cotizador:</label><input type="text" id="edit-cotizador" readonly></div>
                    <div class="form-group"><label>Fecha:</label><input type="text" id="edit-fecha" readonly></div>
                    <div class="form-group"><label>Estatus:</label>
                        <select id="edit-estatus">
                            <option value="Emitida">Emitida</option><option value="Aprobada">Aprobada</option>
                            <option value="Pagada">Pagada</option><option value="Cancelada">Cancelada</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group"><label>Productos:</label><div id="lista-items" class="items-list"></div></div>
                    <div class="financial-box">
                        <div class="financial-row"><span>Costo Base:</span> <span id="val-costo">$0.00</span></div>
                        <div class="financial-row"><span>Utilidad Aprox:</span> <span id="val-utilidad" style="color:green;">$0.00</span></div>
                        <hr>
                        <div class="financial-row"><span>Subtotal Venta:</span> <input type="number" id="edit-subtotal" onchange="recalcularTotal()" style="width:100px; text-align:right;"></div>
                        <div class="financial-row"><span>Gastos Extra:</span> <input type="number" id="edit-gastos" onchange="recalcularTotal()" style="width:100px; text-align:right;"></div>
                        <div class="financial-row"><span>IVA:</span> <span id="val-iva">$0.00</span></div>
                        <div class="financial-row" style="font-weight:bold; font-size: 1.3em; border-top: 1px solid #ccc; padding-top: 5px;"><span>GRAN TOTAL:</span> <span id="val-total">$0.00</span></div>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="guardarCambios()">üíæ Guardar Cambios de Estatus/Montos</button>
        </div>

        <div id="tab-contabilidad" class="tab-content" style="display: none;">
    
    <div class="conta-resumen-grid">
        <div class="form-group" style="margin-bottom:0;">
            <label style="color:#0d47a1;">Total Cotizaci√≥n:</label>
            <input type="text" id="conta-total" readonly style="font-weight:bold; background:#fff; color:#000;">
        </div>
        <div class="form-group" style="margin-bottom:0;">
            <label style="color:#155724;">A Cuenta (Pagado):</label>
            <input type="text" id="conta-pagado" readonly style="font-weight:bold; background:#d4edda; color:#155724;">
        </div>
        <div class="form-group" style="margin-bottom:0;">
            <label style="color:#721c24;">Restante:</label>
            <input type="text" id="conta-restante" readonly style="font-weight:bold; background:#f8d7da; color:#721c24;">
        </div>
    </div>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
        <h3 style="margin-top:0; color: #001f3f; border-bottom: 2px solid #eee; padding-bottom: 10px;">‚ûï Registrar Nuevo Pago</h3>
        
        <div class="conta-form-grid">
            <div class="form-group">
                <label>Fecha Pago:</label>
                <input type="date" id="pago-fecha" style="width:100%; box-sizing:border-box;">
            </div>
            <div class="form-group">
                <label>Tipo de Pago:</label>
                <select id="pago-tipo" style="height: 42px; width:100%; box-sizing:border-box;">
                    <option value="Transferencia">Transferencia</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta d√©bito/cr√©dito</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Monto ($):</label>
                <div class="conta-monto-group">
                    <input type="number" id="pago-monto" step="0.01" placeholder="0.00" style="flex:1; padding:10px;">
                    <button onclick="registrarPago()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">REGISTRAR</button>
                </div>
            </div>
        </div>
    </div>

    <h4 style="margin-bottom: 10px; margin-top: 25px; color: #666;">Historial de Pagos de este folio:</h4>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 0.9em; border: 1px solid #eee; min-width: 300px;">
            <thead>
                <tr style="background: #f1f1f1;">
                    <th>Fecha</th> <th>Tipo</th> <th>Monto</th>
                </tr>
            </thead>
            <tbody id="tabla-pagos-historial">
                <tr><td colspan="3" style="text-align: center; color: #999;">Sin pagos registrados.</td></tr>
            </tbody>
        </table>
    </div>

</div>

    </div> 
</div>
</div>

    <header class="header">

        <div class="nav-container">

            <div class="logo"><img src="/IMG/logo.jpeg" alt="Logo"></div>

            <nav class="nav-links">

                <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>

                <a href="/inicio.html">Inicio</a>

                <a href="/productos.html">Productos</a>

                <a href="/clientes.html">Clientes</a>

                <div class="dropdown">

                    <button class="dropbtn">Cotizaciones ‚ñº</button>

                    <div class="dropdown-content">

                        <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>

                        <a href="/control-cotizaciones.html">Control Cotizaciones</a>

                    </div>

                </div>

            </nav>

        </div>

    </header>



    <div class="historial-container">

        <h1>üìä Historial Resumido de Cotizaciones</h1>

        <input type="file" id="input-excel-importar" style="display: none;" accept=".xlsx, .xls" onchange="procesarArchivoExcel(this)">



       <div class="controls-panel">
    <div class="filter-item">
        <label>Filtro Cliente:</label>
        <select id="filtro-cliente" onchange="aplicarFiltros()">
            <option value="">-- Todos --</option>
        </select>
    </div>
    <div class="filter-item">
        <label>Filtro Cotizador:</label>
        <select id="filtro-cotizador" onchange="aplicarFiltros()">
            <option value="">-- Todos --</option>
        </select>
    </div>
    <div class="actions-group">
        <button onclick="limpiarFiltros()" class="btn-control btn-gray">üîÑ Limpiar</button>
        <button onclick="exportarExcel()" class="btn-control btn-green">‚¨áÔ∏è Excel</button>
        <button onclick="document.getElementById('input-excel-importar').click()" class="btn-control btn-blue">‚¨ÜÔ∏è Importar</button>
        <button onclick="eliminarTodo()" class="btn-control btn-red">‚ò¢Ô∏è Borrar</button>
    </div>
</div>
        </div>


<div class="table-responsive">
        <table id="tabla-cotizaciones">

            <thead>

                <tr>

                    <th class="text-center">#</th>

                    <th class="text-center">Folio</th>

                    <th>Cliente</th>

                    <th>Cotizador</th> <th>Fecha</th>

                    <th class="text-center">Piezas</th>

                    <th class="text-right">Gran Total</th>

                    <th class="text-center">Estatus</th>

                    <th class="text-center">Opciones</th>

                </tr>

            </thead>

            <tbody></tbody>

        </table>
</div>


        <div class="pagination-container" id="panel-paginacion" style="display:none;">

            <button class="btn-paginacion" id="btn-prev" onclick="cambiarPagina(-1)">‚¨ÖÔ∏è Anterior</button>

            <span class="page-info" id="lbl-page-info">0 - 0 de 0</span>

            <button class="btn-paginacion" id="btn-next" onclick="cambiarPagina(1)">Siguiente ‚û°Ô∏è</button>

        </div>

    </div>



   <script>

       let todasLasCotizaciones = []; let datosFiltrados = []; let paginaActual = 1; const filasPorPagina = 20;



    async function cargarHistorial() {

        try {

            const respuesta = await fetch('/cotizaciones');

            let datos = await respuesta.json();

            datos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            const contadoresPorMes = {};

            datos = datos.map(c => {

                const fecha = new Date(c.fecha);

                if(isNaN(fecha)) return c;

                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');

                const anio = fecha.getFullYear();

                const claveMes = `${mes}-${anio}`;

                if (!contadoresPorMes[claveMes]) contadoresPorMes[claveMes] = 0;

                contadoresPorMes[claveMes]++;

                c.folioInteligente = `${contadoresPorMes[claveMes].toString().padStart(3, '0')}-${mes}-${anio}`;

                return c;

            });

            datos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            todasLasCotizaciones = datos; datosFiltrados = datos;

            llenarOpcionesFiltros(); paginaActual = 1; renderizarTabla();

        } catch (error) { console.error(error); }

    }



    function renderizarTabla() {

        const tabla = document.querySelector('#tabla-cotizaciones tbody');

        const panelPaginacion = document.getElementById('panel-paginacion');

        if (datosFiltrados.length === 0) {

            tabla.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 20px;">Sin datos.</td></tr>'; // Aumentado colspan a 9

            panelPaginacion.style.display = 'none'; return;

        }

        panelPaginacion.style.display = 'flex';

        const inicio = (paginaActual - 1) * filasPorPagina;

        const fin = inicio + filasPorPagina;

        const datosPagina = datosFiltrados.slice(inicio, fin);

        tabla.innerHTML = '';

        datosPagina.forEach((c, index) => {

            const indiceReal = inicio + index + 1;

            const fechaObj = new Date(c.fecha);

            const fecha = !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-MX') : '-';

            let cantidadTotal = 0; if (c.items) c.items.forEach(i => cantidadTotal += Number(i.cantidad) || 0);

            const estatus = c.estatus || "Emitida";

           // ... dentro del forEach((c, index) => { ...

    // 1. L√≥gica para saber si mostramos el bot√≥n de respaldo
    // Opci√≥n A: Si usaste la etiqueta "Importado" en tu Excel
    const esImportada = c.quienCotiza === 'Importado';
    
    // Opci√≥n B (M√°s segura): Si la fecha es anterior a HOY (por si acaso)
    // const fechaCorte = new Date('2026-01-01'); // Ajusta a tu fecha de migraci√≥n
    // const esAntigua = new Date(c.fecha) < fechaCorte;

    // Ruta del archivo (asumiendo que los pegaste en public/respaldos)
    const urlRespaldo = `/respaldos/${c._id}.pdf`;
    const nombreDescarga = `Cotizacion_${c.folioInteligente}.pdf`;
    const fila = `<tr>
        <td class="text-center" style="color:#666;">${indiceReal}</td>
        <td class="text-center"><span class="id-row">${c.folioInteligente || 'N/A'}</span></td>
        <td style="font-weight: bold;">${c.cliente}</td>
        <td style="color: #555;">${c.quienCotiza || '---'}</td> 
        <td>${fecha}</td>
        <td class="text-center">${cantidadTotal}</td>
        <td class="text-right"><span class="total">$${(c.total || 0).toFixed(2)}</span></td>
        <td class="text-center"><span class="badge-status">${estatus}</span></td>
        
        <td class="text-center">
            <button class="btn-icon btn-ver" onclick="abrirModalDetalles('${c._id}')" title="Ver Detalles">üëÅÔ∏è</button>
            <button class="btn-icon btn-orden" onclick="generarPDFOrdenTrabajo('${c._id}')" title="Orden de Instalaci√≥n">üî®</button>
            <button class="btn-icon btn-pdf" onclick="generarPDFDesdeHistorial('${c._id}')" title="Re-generar PDF Nuevo">üìÑ</button>

            ${ esImportada ? 
                `<a href="${urlRespaldo}" download="${nombreDescarga}"xt-decoration:none; font-size: 1.2em;" title="Ver Original Escaneado">üóÑÔ∏è</a>` 
                : 
                `<span style="display:inline-block; width: 28px;"></span>` /* Espacio vac√≠o para alinear */
            }

            <button class="btn-icon btn-editar" onclick="enviarACotizador('${c._id}')" title="Editar">‚úèÔ∏è</button>

            <button class="btn-icon btn-borrar" onclick="confirmarBorrado('${c._id}')" title="Borrar">üóëÔ∏è</button>
        </td>
    </tr>`;

    tabla.innerHTML += fila;

// ... cierre del forEach

        });

        actualizarControlesPaginacion();

    }



    // --- FUNCI√ìN ENVIAR A COTIZADOR ---

    function enviarACotizador(id) {

        const c = todasLasCotizaciones.find(item => item._id === id);

        if(!c) return alert("Error: Datos no encontrados");

        const datosParaCotizador = {

            cliente: c.cliente,

            quienCotiza: c.quienCotiza,

            items: c.items,

            gastosAdicionales: c.gastosAdicionales,

            totalGastosAdicionales: c.totalGastosAdicionales,

            iva: c.iva,

            descuentoGlobalPct: c.descuentoGlobalPct || 0

        };

        localStorage.setItem('datosCotizacionEditar', JSON.stringify(datosParaCotizador));

        window.location.href = '/cotizaciones.html';

    }



async function generarPDFDesdeHistorial(id) {

    // 1. Buscar datos

    const c = todasLasCotizaciones.find(item => item._id === id);

    if (!c) return alert("Error: No se encontraron datos.");



    // --- A. RECUPERAR DATOS (INTACTO) ---

    const granTotalBD = c.total || 0;

    const ivaBD = c.iva || 0;

    const tieneIVA = (ivaBD > 0);

   

    // Recuperar Gastos

    let totalGastos = 0;

    let listaGastos = [];

    if (c.gastosAdicionales && Array.isArray(c.gastosAdicionales) && c.gastosAdicionales.length > 0) {

        listaGastos = c.gastosAdicionales;

        totalGastos = listaGastos.reduce((sum, g) => sum + (g.monto || 0), 0);

    } else {

        totalGastos = c.totalGastosAdicionales || 0;

        if(totalGastos > 0) listaGastos.push({ descripcion: "Gastos Extra", monto: totalGastos });

    }



    // --- B. DETERMINAR FACTORES (INTACTO) ---

    let factorUtilidad = 1;

    let factorVisualTabla = 1;



    if (c.pctUtilidad !== undefined && c.pctUtilidad !== null) {

        if (c.pctUtilidad < 100) {

            factorUtilidad = 1 / (1 - (c.pctUtilidad / 100));

        }

        factorVisualTabla = tieneIVA ? 0.84 : 1;



    } else {

        let sumaCostos = c.items.reduce((sum, i) => sum + (i.total || 0), 0);

        let totalNetoVenta = granTotalBD - totalGastos - ivaBD;

        if (!tieneIVA) totalNetoVenta = totalNetoVenta / 0.84;

        if (sumaCostos > 0) factorUtilidad = totalNetoVenta / sumaCostos;

        factorVisualTabla = 1;

    }



    // --- D. CONSTRUIR FILAS (INTACTO) ---

    let filasHTML = '';

    const cellStyle = "padding: 6px; border-right: 1px solid #6CDAE7; font-size: 9px;";

   

    let sumaSubtotalVisual = 0;



    if (c.items && c.items.length > 0) {

        c.items.forEach(item => {

            let m2 = "0.00";

            if (item.medidas && item.medidas.ancho && item.medidas.alto) {

                m2 = (item.medidas.ancho * item.medidas.alto).toFixed(2);

            }



            let costoItem = item.total || 0;

            let precioVentaRow = (costoItem * factorUtilidad) * factorVisualTabla;



            sumaSubtotalVisual += precioVentaRow;



            filasHTML += `

                <tr style="border-bottom: 1px solid #6CDAE7; page-break-inside: avoid;">

                    <td style="${cellStyle} word-wrap: break-word;"><b>${item.producto}</b></td>

                    <td style="${cellStyle}">${item.tela || '-'}</td>

                    <td style="${cellStyle}">${item.color || '-'}</td>

                    <td style="${cellStyle} text-align: center;">${item.cantidad}</td>

                    <td style="${cellStyle}">${item.medidas ? item.medidas.ancho + 'm x ' + item.medidas.alto + 'm' : '-'}</td>

                    <td style="${cellStyle} text-align: center;">${m2} m¬≤</td>

                    <td style="padding: 4px; text-align: right; font-size: 9px;">$${precioVentaRow.toFixed(2)}</td>

                </tr>

                <tr style="border-bottom: 2px solid #6CDAE7; color: #444; font-size: 8px; background-color: #f9f9f9; page-break-inside: avoid;">

                    <td colspan="7" style="padding: 4px 8px;">

                        <div style="margin-bottom: 2px;">

                            <em>

                                ‚ñ∏ Accesorios: ${item.accesorios ? item.accesorios.color : '-'} (${item.accesorios ? item.accesorios.mando : '-'})

                                ${item.motor && item.motor !== 'Manual' ? ` | ‚öôÔ∏è Motor: ${item.motor}` : ''}

                                ${item.control ? ` + üéÆ ${item.control}` : ''}

                            </em>

                        </div>

                        ${item.componente ? `<div style="color:#e65100; font-style:italic;">üîå Extras: ${item.componente}</div>` : ""}

                        ${item.notas ? `<div style="color:#d63384; font-style:italic; margin-top:2px;">üìù Nota: ${item.notas}</div>` : ""}

                    </td>

                </tr>`;

        });

    }



    // --- E. PREPARAR TOTALES (INTACTO) ---

    let descuentoVisual = 0;

    if (c.descuentoGlobalMonto > 0) {

        if (factorVisualTabla === 1) {

             descuentoVisual = c.descuentoGlobalMonto;

        } else {

             descuentoVisual = (c.descuentoGlobalMonto / 1.16) * 0.84;

        }

        if(c.descuentoGlobalPct) {

             descuentoVisual = sumaSubtotalVisual * (c.descuentoGlobalPct / 100);

        }

    }





    // --- F. ESTRUCTURA PDF (CORREGIDA: MODELO "ANCHO FIJO + PADDING") ---

    // Esta configuraci√≥n imita la de tu funci√≥n 'generarPDF' original que funcionaba bien.

    const element = document.createElement('div');

   

    // 1. VOLVEMOS AL ANCHO FIJO DE 816px (Carta)

    // Esto asegura que html2canvas sepa exactamente cu√°nto mide la hoja.

    element.style.width = '816px';

    element.style.minHeight = '1056px';

    element.style.boxSizing = 'border-box';

   

    // 2. USAMOS PADDING INTERNO PARA EL MARGEN

    // 40px de padding simulan el margen visual.

    element.style.padding = '40px';

   

    element.style.background = 'white';

    element.style.fontFamily = 'Arial, sans-serif';

    element.style.color = '#333';

    element.style.fontSize = '10px';

    element.style.lineHeight = '1.3';



    element.innerHTML = `

        <div style="width: 100%;">

            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #17a2b8; padding-bottom: 10px; margin-bottom: 15px;">

                <div style="width: 45%;">

                    <img src="/IMG/logopd.png" alt="Persianas Delta" style="max-width: 200px;">

                    <div style="color: #17a2b8; font-weight: bold; letter-spacing: 2px; margin-top: 2px; font-size: 9px;">PRIVACIDAD CON ESTILO</div>

                </div>

                <div style="width: 55%; text-align: right; font-size: 10px;">

                    <h1 style="margin: 0; font-weight: normal; font-size: 20px; letter-spacing: 2px; color: #333;">PERSIANAS DELTA</h1>

                    <p style="margin: 3px 0;">CDMX 5519337007 / CDMX 5581973360</p>

                    <p style="margin: 1px 0;">https://persianasdelta.com/</p>

                    <p style="margin: 0; font-weight: bold;">ventas@persianasdelta.com</p>

                </div>

            </div>



            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 5px;">

                <div style="width: 60%;">

                    <div style="margin-bottom: 3px;"><strong style="color: #001f3f;">COTIZACI√ìN:</strong> <span style="font-size: 1.1em;">${c.folioInteligente || c.folio || 'S/N'}</span></div>

                    <div><strong style="color: #001f3f;">CLIENTE:</strong> <span style="font-size: 1.1em;">${c.cliente}</span></div>

                </div>

                <div style="text-align: right;">

                    <strong style="color: #001f3f;">FECHA DE EMISI√ìN:</strong><br>

                    ${new Date(c.fecha).toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}

                    <br><strong>ATENDI√ì:</strong> ${c.quienCotiza || '---'}

                </div>

            </div>



            <table style="width: 100%; border-collapse: collapse; font-size: 9px; border: 2px solid #17a2b8; margin-bottom: 20px;">

                <thead style="display: table-header-group;">

                    <tr style="text-align: center;">

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">TIPO</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">TELA</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">COLOR</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">CANT.</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">MEDIDAS</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">TOTAL M¬≤</th>

                        <th style="border: 1px solid #5abfd1; padding: 6px; background-color: #6CDAE7; color: black;">TOTAL</th>

                    </tr>

                </thead>

                <tbody>${filasHTML}</tbody>

            </table>



            <div style="display: flex; justify-content: space-between; page-break-inside: avoid;">

                <div style="width: 55%; font-size: 9px; color: #555; text-align: justify;">

                    <p style="margin-bottom: 3px; font-weight: bold; color: #000;">T√âRMINOS Y CONDICIONES:</p>

                    <ul style="padding-left: 15px; margin: 0;">

                        <li>Se requiere el 50% de anticipo para iniciar producci√≥n y el 50% restante contra entrega.</li>

                        <li>Una vez realizado el anticipo <strong>no hay cambios ni devoluciones</strong>.</li>

                        <li>Los precios est√°n expresados en Moneda Nacional (MXN).</li>

                        <li>Tiempo estimado de entrega: 7 a 10 d√≠as h√°biles.</li>

                        <li>Vigencia de cotizaci√≥n: 15 d√≠as naturales.</li>

                        <li><strong>Banco BBVA</strong></li>

                        <li>DELTA LAG COMERCIALIZADORA</li>

                        <li>No. Cuenta 0115901758</li>

                        <li>Cuenta CLABE 012180001159017589</li>

                    </ul>

                </div>



                <div style="width: 40%;">

                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">

                        <tr>

                            <td style="text-align: right; padding: 4px; font-weight: bold; color: #555;">SUBTOTAL:</td>

                            <td style="text-align: right; padding: 4px; color: #333;">$${sumaSubtotalVisual.toFixed(2)}</td>

                        </tr>

                        ${descuentoVisual > 0 ? `

                        <tr>

                            <td style="text-align: right; padding: 4px; font-weight: bold; color: #dc3545;">DESCUENTO (${c.descuentoGlobalPct || 0}%):</td>

                            <td style="text-align: right; padding: 4px; color: #dc3545;">-$${descuentoVisual.toFixed(2)}</td>

                        </tr>` : ''}

                       

                        ${totalGastos > 0 ?

                            listaGastos.map(g => `

                            <tr>

                                <td style="text-align: right; padding: 4px; font-weight: bold; color: #6610f2;">+ ${g.descripcion || 'Gasto Extra'}:</td>

                                <td style="text-align: right; padding: 4px; color: #6610f2;">$${(g.monto || 0).toFixed(2)}</td>

                            </tr>`).join('')

                        : ''}



                        <tr>

                            <td style="text-align: right; padding: 4px; font-weight: bold; color: #555;">IVA (16%):</td>

                            <td style="text-align: right; padding: 4px; color: #333;">${tieneIVA ? '$'+ivaBD.toFixed(2) : 'No Incluido'}</td>

                        </tr>

                        <tr style="border-top: 2px solid #17a2b8;">

                            <td style="text-align: right; padding: 6px; font-weight: bold; color: #001f3f; font-size: 13px;">TOTAL NETO:</td>

                            <td style="text-align: right; padding: 6px; font-weight: bold; color: #001f3f; font-size: 13px;">$${granTotalBD.toFixed(2)}</td>

                        </tr>

                    </table>

                </div>

            </div>

        </div>



          <div>



            <div style="margin-top: 15px; border-top: 2px solid #6CDAE7; border-bottom: 2px solid #6CDAE7; padding: 12px 0; font-size: 7px; color: #444; text-align: justify; page-break-inside: avoid;">



                 <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">



                     <div style="width: 48%;">



                        <ul style="margin: 0; padding-left: 10px; list-style-type: disc; line-height: 1.4;">



                            <li style="margin-bottom: 4px;">Cualquier modificaci√≥n en la cotizaci√≥n despu√©s del anticipo se le aplicar√° un cargo m√≠nimo de $600 pesos dentro de la Ciudad de M√©xico.</li>



                            <li style="margin-bottom: 4px;">Ancho m√°ximo sugerido (2.20), mayor a esta medida se sugiere dividir la persiana.</li>



                            <li style="margin-bottom: 4px;">Por ser productos hechos a la medida, al momento de levantar el pedido no hay cambios, cancelaciones ni devoluciones.</li>



                            <li style="margin-bottom: 4px;">Se requiere el 50% de anticipo al confirmar el pedido, el resto al concluir la instalaci√≥n.</li>



                            <li style="margin-bottom: 4px;">No se aceptan cambios, cancelaciones ni devoluciones despu√©s de recibir su pedido por ser productos hechos a la medida. (En caso de cancelaci√≥n ser√° con un cargo al cliente del 30 % del total y solamente si dicha cancelaci√≥n se hace dentro de las 24 horas posteriores al levantamiento del pedido).</li>



                            <li style="margin-bottom: 4px;">La empresa no se hace responsable por techos, pisos, paredes irregulares, deformes, con humedad o en mal estado, plafones mal colocados, tuber√≠as, cableado o vicios ocultos, as√≠ como decoloraciones en las telas por el sol y/o qu√≠micos.</li>



                            <li style="margin-bottom: 4px;">Todos nuestros productos se pueden motorizar y/o automatizar, por lo que de requerir las persianas as√≠, el cliente debe contar en cada √°rea con salidas o tomas de corriente el√©ctricas aterrizadas.</li>



                            <li style="margin-bottom: 4px;">Los motores cuentan con garant√≠a, misma que ser√° en f√°brica, (est√°n excluidas las descargas el√©ctricas) la que determine el fabricante con un diagn√≥stico; por lo que si se solicita, este se llevar√° hasta 5 d√≠as h√°biles. (Si el cliente requiere el servicio de recolecci√≥n, retiro y reinstalaci√≥n de su persiana ser√° con cargo adicional).</li>



                        </ul>



                    </div>



                    <div style="width: 48%;">



                        <ul style="margin: 0; padding-left: 10px; list-style-type: disc; line-height: 1.4;">



                            <li style="margin-bottom: 4px;">Para respetar la promoci√≥n de instalaci√≥n gratis, es posible reprogramar la instalaci√≥n solicit√°ndolo con 48 hrs de anticipaci√≥n, en caso contrario la reprogramaci√≥n de instalaci√≥n tendr√° un costo de $800 pesos. La nula respuesta de confirmaci√≥n se toma en cuenta como cancelaci√≥n.</li>



                            <li style="margin-bottom: 4px;">En el caso de que el cliente modifique las medidas ya autorizadas, ser√° responsable de los efectos que de esto resulte.</li>



                            <li style="margin-bottom: 4px;">Despu√©s de la instalaci√≥n o recepci√≥n de los productos, cualquier reclamaci√≥n ser√° v√°lida solo 24 horas despu√©s de la recepci√≥n del mismo.</li>



                            <li style="margin-bottom: 4px;">Nuestra empresa cuenta con garant√≠a en todos nuestros productos y son v√°lidas en planta (despu√©s de ser revisadas y autorizadas por control de calidad el cual dar√° el diagn√≥stico), en caso de que aplique alguna, para que esta proceda, se tomar√° en cuenta, el diagn√≥stico, el uso, maltrato, mantenimiento, tiempo, desgaste, si el cliente requiere recolecci√≥n, retiro y reinstalaci√≥n ser√° con cargo adicional.</li>



                            <li style="margin-bottom: 4px;">En caso de que el cliente no est√© presente en la toma de medidas, la persona que nos atienda ser√° la responsable de proporcionar los datos, mismos que se reconocer√°n en el pedido como v√°lidos en la rectificaci√≥n de medidas.</li>



                            <li style="margin-bottom: 4px;">El √°rea a instalar deber√° estar libre; nuestro personal no se hace responsable por desmontar cortineros, cortinas, drapeadas o cualquier otro art√≠culo decorativo; en caso de as√≠ requerirse deber√° ser notificado a su vendedor el d√≠a del levantamiento.</li>



                            <li style="margin-bottom: 4px;">La empresa no se hace responsable por da√±os ocasionados (si el cliente le solicita al personal el movimiento de mobiliario u otros objetos, por lo que ser√° bajo su responsabilidad).</li>



                            <li style="margin-bottom: 4px;">El personal de la empresa no est√° autorizado para hacer trabajos no especificados en la orden.</li>



                        </ul>



                    </div>



                </div>



            </div>



           



            <div style="text-align: center; font-weight: bold; font-size: 10px; margin-top: 10px; color: #000;">



                ***Se mejora cualquier cotizaci√≥n***



            </div>



        </div>



    `;







    const opt = {

        // 3. QUITAMOS EL MARGEN DEL PDF

        // Ya lo estamos manejando con el padding de 40px en el HTML.

        margin: 0,

       

        filename: `Cotizacion_${c.folioInteligente || c.folio || '00'}.pdf`,

        image: { type: 'jpeg', quality: 1 },

       

        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },

       

        html2canvas: { scale: 4, useCORS: true, letterRendering: true, scrollY: 0 },

        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }

    };



    document.body.style.cursor = 'wait';

    try {

        await html2pdf().set(opt).from(element).save();

    } catch (error) {

        console.error("Error generando PDF", error);

        alert("Hubo un problema generando el PDF.");

    }

    document.body.style.cursor = 'default';

}

    // --- FUNCI√ìN ABRIR MODAL (ACTUALIZADA CON CONTABILIDAD) ---
function abrirModalDetalles(id) {
    const c = todasLasCotizaciones.find(item => item._id === id);
    if (!c) return;

    // --- 1. RESETEAR PESTA√ëAS AL ABRIR ---
    cambiarPestana('detalles'); // Siempre empezar en la pesta√±a 1
    document.getElementById('edit-id').value = c._id;
    document.getElementById('modal-titulo').innerText = `Detalles: ${c.folioInteligente}`;

    // --- 2. LLENAR PESTA√ëA DETALLES (Tu c√≥digo existente) ---
    document.getElementById('edit-folio').value = c.folioInteligente;
    document.getElementById('edit-cliente').value = c.cliente;
    document.getElementById('edit-cotizador').value = c.quienCotiza || 'N/A';
    document.getElementById('edit-fecha').value = new Date(c.fecha).toLocaleString();
    document.getElementById('edit-estatus').value = c.estatus || 'Emitida';

    // Valores financieros existentes
    let granTotal = c.total || 0;
    let gastos = c.totalGastosAdicionales || 0;
    let iva = c.iva || 0;
    // Intentamos ingenier√≠a inversa para obtener el subtotal sin iva ni gastos para los inputs
    let subtotalBase = granTotal - iva - gastos; 
    if(subtotalBase < 0) subtotalBase = granTotal; // Protecci√≥n

    document.getElementById('edit-subtotal').value = subtotalBase.toFixed(2);
    document.getElementById('edit-gastos').value = gastos.toFixed(2);

    // Recalcular costos base de items para mostrar utilidad aprox
    let costoTotalProduccion = 0;
    const listaItems = document.getElementById('lista-items');
    listaItems.innerHTML = '';
    if (c.items && c.items.length > 0) {
        c.items.forEach(item => {
            if (item.financiero && item.financiero.costoBase) {
                costoTotalProduccion += (item.financiero.costoBase * item.cantidad);
            }
            listaItems.innerHTML += `<div class="item-row"><span>${item.cantidad}x ${item.producto}</span><strong>$${(item.total || 0).toFixed(2)}</strong></div>`;
        });
    }
    document.getElementById('val-costo').innerText = `$${costoTotalProduccion.toFixed(2)}`;
    // Ejecutamos recalcular para que se llenen el IVA, Total y Utilidad en la vista
    recalcularTotal();


    // --- 3. LLENAR PESTA√ëA CONTABILIDAD (NUEVO) ---
    
    // A) Calcular lo pagado hasta ahora
    let totalPagado = 0;
    const tbodyHistorial = document.getElementById('tabla-pagos-historial');
    tbodyHistorial.innerHTML = '';

    if(c.pagos && Array.isArray(c.pagos) && c.pagos.length > 0) {
        // Sumamos los pagos y llenamos la tablita
        c.pagos.forEach(p => {
            totalPagado += (p.monto || 0);
            const fechaP = new Date(p.fechaPago).toLocaleDateString('es-MX', { timeZone: 'UTC' });
             tbodyHistorial.innerHTML += `
                <tr>
                    <td>${fechaP}</td>
                    <td>${p.tipoPago}</td>
                    <td style="font-weight:bold;">$${(p.monto || 0).toFixed(2)}</td>
                </tr>`;
        });
    } else {
        tbodyHistorial.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">Sin pagos registrados.</td></tr>';
    }

    const restante = granTotal - totalPagado;

    // B) Formateador de moneda
    const f = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

    // C) Llenar los inputs de resumen
    document.getElementById('conta-total').value = f.format(granTotal);
    document.getElementById('conta-pagado').value = f.format(totalPagado);
    document.getElementById('conta-restante').value = f.format(restante);

    // D) Resetear formulario de nuevo pago
    const hoy = new Date();
    const localDate = new Date(hoy.getTime() - (hoy.getTimezoneOffset() * 60000)).toISOString().split("T")[0];
document.getElementById('pago-fecha').value = localDate;
    document.getElementById('pago-monto').value = '';
    // Sugerir el restante si es mayor a 0
    if(restante > 0) {
         document.getElementById('pago-monto').placeholder = restante.toFixed(2);
    }

    document.getElementById('modal-detalles').style.display = 'flex';
}


    // --- NUEVA FUNCI√ìN: REGISTRAR PAGO ---
async function registrarPago() {
    const id = document.getElementById('edit-id').value;
    const fecha = document.getElementById('pago-fecha').value;
    const tipo = document.getElementById('pago-tipo').value;
    const montoTxt = document.getElementById('pago-monto').value;
    const monto = parseFloat(montoTxt);

    // Validaciones b√°sicas
    if(!fecha) return alert("Selecciona una fecha de pago.");
    if(isNaN(monto) || monto <= 0) return alert("Ingresa un monto v√°lido mayor a 0.");

    // Validaci√≥n opcional: No pagar m√°s de lo que se debe
    const restanteTxt = document.getElementById('conta-restante').value.replace(/[$,]/g,''); // Quitar $ y comas
    const restante = parseFloat(restanteTxt);
    if(monto > restante + 1) { // +1 de margen por decimales
        if(!confirm(`‚ö†Ô∏è Est√°s registrando un pago ($${monto.toFixed(2)}) mayor al restante ($${restante.toFixed(2)}). ¬øDeseas continuar?`)) {
            return;
        }
    }

    try {
        const res = await fetch(`/cotizaciones/${id}/pagos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fechaPago: fecha, monto: monto, tipoPago: tipo })
        });

        const data = await res.json();

        if(data.exito) {
            alert("‚úÖ Pago registrado con √©xito.");
            
            // OJO: Truco para actualizar la vista sin recargar toda la p√°gina
            // 1. Buscamos la cotizaci√≥n en nuestro arreglo local
            const index = todasLasCotizaciones.findIndex(c => c._id === id);
            if(index !== -1) {
                // 2. Le actualizamos sus pagos con lo que devolvi√≥ el servidor
                todasLasCotizaciones[index].pagos = data.pagos;
                
                // 3. Si el restante ahora es 0 o menos, sugerimos cambiar estatus a Pagada
                const totalCot = todasLasCotizaciones[index].total || 0;
                const totalPagado = data.pagos.reduce((sum, p) => sum + p.monto, 0);
                if(totalPagado >= totalCot - 1) { // Margen de $1 por redondeo
                     const confirmar = confirm("El total ha sido cubierto. ¬øDeseas cambiar el estatus a 'Pagada' ahora?");
                     if(confirmar) {
                         document.getElementById('edit-estatus').value = 'Pagada';
                         // Llamamos a guardarCambios para que se guarde el nuevo estatus
                         await guardarCambios(); 
                         return; // guardarCambios ya cierra el modal y recarga
                     }
                }
            }
            
            // Si no se cambi√≥ el estatus, solo recargamos el historial para ver los cambios
            cargarHistorial();
            cerrarModal();

        } else {
            alert("Error: " + data.mensaje);
        }

    } catch (error) {
        console.error(error);
        alert("Error de conexi√≥n al registrar el pago.");
    }
}
    function recalcularTotal() { const sub = parseFloat(document.getElementById('edit-subtotal').value) || 0; const gas = parseFloat(document.getElementById('edit-gastos').value) || 0; const iva = (sub + gas) * 0.16; const total = sub + gas + iva; const txtCosto = document.getElementById('val-costo').innerText.replace('$',''); const costo = parseFloat(txtCosto) || 0; const utilidad = (sub + gas) - costo; document.getElementById('val-iva').innerText = `$${iva.toFixed(2)}`; document.getElementById('val-total').innerText = `$${total.toFixed(2)}`; const lblUtil = document.getElementById('val-utilidad'); lblUtil.innerText = `$${utilidad.toFixed(2)}`; lblUtil.style.color = utilidad >= 0 ? 'green' : 'red'; }

    async function guardarCambios() { const id = document.getElementById('edit-id').value; const cliente = document.getElementById('edit-cliente').value; const estatus = document.getElementById('edit-estatus').value; const sub = parseFloat(document.getElementById('edit-subtotal').value) || 0; const gas = parseFloat(document.getElementById('edit-gastos').value) || 0; const iva = (sub + gas) * 0.16; const total = sub + gas + iva; const datosUpdate = { id: id, cliente: cliente, estatus: estatus, total: total, iva: iva, totalGastosAdicionales: gas }; try { const res = await fetch('/cotizaciones', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(datosUpdate) }); const r = await res.json(); if(r.exito) { alert("‚úÖ Cambios guardados."); cerrarModal(); cargarHistorial(); } else { alert("Error al guardar."); } } catch(e) { console.error(e); alert("Error de conexi√≥n"); } }

    function cerrarModal() { document.getElementById('modal-detalles').style.display = 'none'; }

    function actualizarControlesPaginacion() { const btnPrev = document.getElementById('btn-prev'); const btnNext = document.getElementById('btn-next'); const lblInfo = document.getElementById('lbl-page-info'); const totalRegistros = datosFiltrados.length; const totalPaginas = Math.ceil(totalRegistros / filasPorPagina); const inicio = (paginaActual - 1) * filasPorPagina + 1; let fin = paginaActual * filasPorPagina; if(fin > totalRegistros) fin = totalRegistros; lblInfo.innerText = `Mostrando ${inicio} - ${fin} de ${totalRegistros}`; btnPrev.disabled = (paginaActual === 1); btnNext.disabled = (paginaActual === totalPaginas || totalPaginas === 0); }

    function cambiarPagina(dir) { paginaActual += dir; renderizarTabla(); }

    function aplicarFiltros() { const cli = document.getElementById('filtro-cliente').value; const cot = document.getElementById('filtro-cotizador').value; datosFiltrados = todasLasCotizaciones.filter(c => (cli ? c.cliente === cli : true) && (cot ? c.quienCotiza === cot : true)); paginaActual = 1; renderizarTabla(); }

    function limpiarFiltros() { document.getElementById('filtro-cliente').value = ""; document.getElementById('filtro-cotizador').value = ""; datosFiltrados = todasLasCotizaciones; paginaActual = 1; renderizarTabla(); }

    function llenarOpcionesFiltros() { const selCli = document.getElementById('filtro-cliente'); const selCot = document.getElementById('filtro-cotizador'); if(selCli.options.length > 1) return; [...new Set(todasLasCotizaciones.map(c => c.cliente))].sort().forEach(x => selCli.add(new Option(x, x))); [...new Set(todasLasCotizaciones.map(c => c.quienCotiza).filter(Boolean))].sort().forEach(x => selCot.add(new Option(x, x))); }

    function procesarArchivoExcel(input) { const archivo = input.files[0]; if (!archivo) return; const reader = new FileReader(); reader.onload = async function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array', cellDates: false}); const hoja = workbook.Sheets[workbook.SheetNames[0]]; const datosExcel = XLSX.utils.sheet_to_json(hoja, { range: 1 }); if(datosExcel.length===0) return alert("Vac√≠o"); if(!confirm(`Importar ${datosExcel.length}?`)) return; document.getElementById('loading-overlay').style.display='flex'; let ok=0; for(let row of datosExcel) { let fechaFinal = new Date(); const fechaRaw = row['Fecha']; if (typeof fechaRaw === 'number') fechaFinal = new Date((fechaRaw - 25569)*86400*1000); else if (typeof fechaRaw === 'string') { const p = fechaRaw.split('/'); if(p.length===3) fechaFinal=new Date(p[2],p[1]-1,p[0]); } const obj = { cliente: row['Cliente']||"Imp", fecha: fechaFinal, total: row['Total']||0, quienCotiza:"Importado", items:[{cantidad:row['Piezas']||1, total:row['Total']||0}] }; try { await fetch('/cotizaciones', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)}); ok++; } catch(e){} } document.getElementById('loading-overlay').style.display='none'; alert(`Imp: ${ok}`); input.value=''; cargarHistorial(); }; reader.readAsArrayBuffer(archivo); }

    function exportarExcel() { if (datosFiltrados.length === 0) { alert("No hay datos"); return; } const datosFormateados = datosFiltrados.map(c => { let cantidadTotal = 0; if (c.items) c.items.forEach(item => cantidadTotal += Number(item.cantidad) || 0); return { "Folio": c.folioInteligente, "Cliente": c.cliente, "Fecha": new Date(c.fecha).toLocaleDateString('es-MX'), "Cotizador": c.quienCotiza, "Piezas": cantidadTotal, "Total": c.total }; }); const ws = XLSX.utils.json_to_sheet(datosFormateados); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Cotizaciones"); XLSX.writeFile(wb, `Reporte_${new Date().toISOString().split('T')[0]}.xlsx`); }

    async function eliminarTodo() { if(todasLasCotizaciones.length === 0) return alert("Nada que borrar."); if (!confirm("‚ö†Ô∏è ¬øELIMINAR TODO EL HISTORIAL?")) return; const password = prompt("üîí Password:"); if (!password) return; document.querySelector('.loader-text').innerText = "üóëÔ∏è Eliminando..."; document.getElementById('loading-overlay').style.display='flex'; let eliminados = 0; for (let c of todasLasCotizaciones) { try { await fetch('/cotizaciones', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: c._id, password: password }) }); eliminados++; } catch (error) {} } document.getElementById('loading-overlay').style.display='none'; alert(`üßπ Eliminados: ${eliminados}`); cargarHistorial(); }

    async function confirmarBorrado(id) { const password = prompt("üîí Password:"); if (!password) return; try { const res = await fetch('/cotizaciones', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, password: password }) }); const data = await res.json(); if (data.exito) { alert("Eliminado"); cargarHistorial(); } else { alert(data.mensaje); } } catch (error) { alert("Error red"); } }



    cargarHistorial();

// --- FUNCI√ìN: ORDEN DE INSTALACI√ìN (MARTILLO) ---
async function generarPDFOrdenTrabajo(id) {
    const c = todasLasCotizaciones.find(item => item._id === id);
    if (!c) return alert("Error: Datos no encontrados.");

    let filasHTML = '';
    const cellStyle = "padding: 6px; border: 1px solid #444; font-size: 10px; vertical-align: top;";
    
    if (c.items && c.items.length > 0) {
        c.items.forEach((item, index) => {
            // L√≥gica de seguridad: Si no existe el dato, ponemos texto vac√≠o o guiones
            const textoMando = (item.accesorios && item.accesorios.mando) ? item.accesorios.mando : '-';
            const textoColorAcc = (item.accesorios && item.accesorios.color) ? item.accesorios.color : '-';
            
            // Construimos la lista de especificaciones
            let especificacionesHTML = `
                <div style="margin-bottom: 2px;"><strong>‚ñ™ Mando:</strong> ${textoMando}</div>
                <div style="margin-bottom: 2px;"><strong>‚ñ™ Color Acc:</strong> ${textoColorAcc}</div>
            `;

            if (item.motor && item.motor !== 'Manual') {
                especificacionesHTML += `<div style="color: #0056b3; font-weight: bold; margin-top: 3px;">‚ö° Motor: ${item.motor}</div>`;
            }
            
            // OJO: Aqu√≠ intentamos leer 'control' y 'componente'. 
            // Si en tu BD antigua no est√°n, simplemente no se mostrar√°n.
            if (item.control) {
                especificacionesHTML += `<div style="color: #0056b3;">üéÆ Control: ${item.control}</div>`;
            }

            if (item.componente) {
                especificacionesHTML += `<div style="color: #e65100; font-style: italic; margin-top: 3px; border-top: 1px dotted #ccc; padding-top:2px;">üîå Extras: ${item.componente}</div>`;
            }

            const notaTexto = item.notas ? item.notas : '';

            filasHTML += `
                <tr style="border-bottom: 1px solid #6CDAE7; page-break-inside: avoid;">
                    <td style="${cellStyle} text-align: center; font-weight: bold; background: #f0f0f0; vertical-align: middle;">${index + 1}</td>
                    <td style="${cellStyle} text-align: center; font-size: 1.1em; vertical-align: middle;">${item.cantidad}</td>
                    <td style="${cellStyle}">
                        <strong style="font-size: 1.1em; color: #000;">${item.producto}</strong><br>
                        <span style="color: #444;">Tela: ${item.tela || '-'}</span><br>
                        <span style="color: #444;">Color: ${item.color || '-'}</span>
                    </td>
                    <td style="${cellStyle} text-align: center; font-weight: bold; font-size: 1.1em; vertical-align: middle;">
                        ${item.medidas ? item.medidas.ancho + ' x ' + item.medidas.alto : '-'}
                    </td>
                    <td style="${cellStyle}">
                        ${especificacionesHTML}
                    </td>
                    <td style="${cellStyle} background: ${notaTexto ? '#fff8e1' : 'white'}; color: #d63384;">
                        ${notaTexto}
                    </td>
                    <td style="${cellStyle} text-align: center; vertical-align: middle;">
                        <div style="width: 20px; height: 20px; border: 2px solid #ccc; margin: auto;"></div>
                    </td>
                </tr>`;
        });
    }

    const element = document.createElement('div');
    element.style.width = '816px'; 
    element.style.minHeight = '1056px'; 
    element.style.boxSizing = 'border-box';
    element.style.padding = '40px';
    element.style.background = 'white';
    element.style.fontFamily = 'Arial, sans-serif';
    element.style.color = '#333';
    element.style.fontSize = '11px';
    element.style.display = 'flex';
    element.style.flexDirection = 'column';
    element.style.justifyContent = 'space-between';

    element.innerHTML = `
        <div style="flex: 1;">
            <div style="border-bottom: 3px solid #fd7e14; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="width: 50%;">
                    <img src="/IMG/logopd.png" alt="Persianas Delta" style="max-width: 180px;">
                    <div style="font-size: 14px; font-weight: bold; color: #333; margin-top: 5px;">ORDEN DE INSTALACI√ìN</div>
                </div>
                <div style="width: 50%; text-align: right;">
                    <div style="font-size: 1.4em; font-weight: bold; color: #fd7e14;">FOLIO: ${c.folioInteligente}</div>
                    <div style="margin-top: 5px;"><strong>Fecha:</strong> ${new Date(c.fecha).toLocaleDateString('es-MX')}</div>
                   
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 5px 0; color: #fd7e14; font-size: 1em;">üìç CLIENTE / UBICACI√ìN</h3>
                <div style="font-size: 1.2em; font-weight: bold; color: #000;">${c.cliente}</div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background-color: #333; color: white; text-align: center;">
                        <th style="padding: 8px; border: 1px solid #444; width: 30px;">#</th>
                        <th style="padding: 8px; border: 1px solid #444; width: 40px;">Cant</th>
                        <th style="padding: 8px; border: 1px solid #444;">Producto / Descripci√≥n</th>
                        <th style="padding: 8px; border: 1px solid #444; width: 90px;">Medidas</th>
                        <th style="padding: 8px; border: 1px solid #444;">Especificaciones T√©cnicas</th>
                        <th style="padding: 8px; border: 1px solid #444; width: 120px;">Notas / Obs.</th>
                        <th style="padding: 8px; border: 1px solid #444; width: 30px;">OK</th>
                    </tr>
                </thead>
                <tbody>
                    ${filasHTML}
                </tbody>
            </table>
            
            <div style="border: 1px dashed #999; padding: 10px; color: #666; margin-top: 10px; min-height: 50px;">
                <strong>Observaciones Generales de la Instalaci√≥n:</strong>
            </div>
        </div>

        <div>
            <div style="display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid;">
                <div style="width: 40%; text-align: center;">
                    <div style="border-top: 1px solid #000; padding-top: 5px; font-weight: bold;">Firma del Instalador</div>
                    <div style="font-size: 9px; color: #666;">Trabajo terminado</div>
                </div>
                <div style="width: 40%; text-align: center;">
                    <div style="border-top: 1px solid #000; padding-top: 5px; font-weight: bold;">Firma de Conformidad Cliente</div>
                    <div style="font-size: 9px; color: #666;">Recib√≠ a entera satisfacci√≥n</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; font-size: 9px; color: #aaa;">
                Uso exclusivo Operaciones - Persianas Delta
            </div>
        </div>
    `;

    const opt = { 
        margin: 0,
        filename: `Orden_Instalacion_${c.folioInteligente}.pdf`, 
        image: { type: 'jpeg', quality: 0.98 }, 
        html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }, 
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
    };

    document.body.style.cursor = 'wait';
    try {
        await html2pdf().set(opt).from(element).save();
    } catch (error) {
        console.error("Error", error);
        alert("Error al generar PDF.");
    }
    document.body.style.cursor = 'default';
}
   </script>

</body>

</html>