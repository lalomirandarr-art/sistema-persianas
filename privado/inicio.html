<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - Dashboard General</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS ESPEC√çFICOS DEL DASHBOARD --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .dashboard-container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        .welcome-banner {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Tarjetas de Resumen (N√∫meros grandes) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            border-bottom: 4px solid #ddd;
        }

        .kpi-card h3 { margin: 0; color: #666; font-size: 0.9em; text-transform: uppercase; }
        .kpi-card p { margin: 10px 0 0 0; font-size: 1.8em; font-weight: bold; color: #001f3f; }

        /* Colores de borde para las tarjetas */
        .border-blue { border-bottom-color: #007bff; }
        .border-green { border-bottom-color: #28a745; }
        .border-red { border-bottom-color: #dc3545; }
        .border-orange { border-bottom-color: #fd7e14; }

        /* Contenedor de Gr√°ficas */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr; /* Por defecto 1 columna */
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media(min-width: 900px) {
            .charts-grid { grid-template-columns: repeat(3,1fr); } /* PC: Izquierda ancha, derecha angosta */
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        /* Spinner de carga */
        #loader-dashboard { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
    </style>
</head>
<body>

    <header class="header">
        <div class="nav-container">
            <div class="logo"><img src="/IMG/logo.jpeg" alt="Logo"></div>
            <nav class="nav-links">
                <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
                <a href="/inicio.html" style="font-weight:bold; color:#17a2b8;">Inicio</a>
                <a href="/productos.html">Productos</a>
                <a href="/clientes.html">Clientes</a>
                <div class="dropdown">
                    <button class="dropbtn">Cotizaciones ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                        <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="dashboard-container">
        
        <div class="welcome-banner">
            <h1 style="margin:0;">üëã Bienvenido al Panel de Control</h1>
            <p style="margin:5px 0 0 0; opacity: 0.8;">Resumen de actividad (Excluyendo datos importados)</p>
        </div>

        <div id="loader-dashboard">üîÑ Analizando datos...</div>

        <div id="dashboard-content" style="display: none;">
            
            <div class="kpi-grid">
                <div class="kpi-card border-blue">
                    <h3>Cotizaciones Totales</h3>
                    <p id="kpi-total">0</p>
                </div>
                <div class="kpi-card border-green">
                    <h3>Ventas Aprobadas</h3>
                    <p id="kpi-aprobadas">0</p>
                </div>
                <div class="kpi-card border-orange">
                    <h3>Monto Pendiente</h3>
                    <p id="kpi-pendiente">$0.00</p>
                </div>
                <div class="kpi-card border-red">
                    <h3>Ingreso Estimado (Aprob)</h3>
                    <p id="kpi-dinero" style="color: #28a745;">$0.00</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">üèÜ Top Productos Cotizados (Por Piezas)</div>
                    <canvas id="chartProductos"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">üìä Estatus de Cotizaciones</div>
                    <canvas id="chartEstatus"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">üí≥ M√©todos de Pago</div>
                    <canvas id="chartPagos"></canvas>
                </div>
            </div>

            <div class="chart-card" style="margin-bottom: 20px;">
                <div class="chart-title">üìÖ Comportamiento Mensual (Monto Cotizado)</div>
                <canvas id="chartMensual" style="max-height: 300px;"></canvas>
            </div>

        </div>
    </div>

    <script>
        // --- L√ìGICA DEL DASHBOARD ---

        async function cargarDashboard() {
            try {
                // 1. Obtenemos TODAS las cotizaciones
                const res = await fetch('/cotizaciones');
                const todosLosDatos = await res.json();

                // 2. FILTRO MAESTRO: Ignorar "Importado"
                // Aqu√≠ est√° la l√≥gica que pediste: solo pasan los que NO son 'Importado'
                const datos = todosLosDatos.filter(c => c.quienCotiza !== 'Importado');

                // Si no hay datos despu√©s del filtro
                if (datos.length === 0) {
                    document.getElementById('loader-dashboard').innerText = "No hay datos recientes para mostrar.";
                    return;
                }

                calcularKPIs(datos);
                renderizarGraficas(datos);

                // Mostrar el dashboard y ocultar loader
                document.getElementById('loader-dashboard').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

            } catch (error) {
                console.error(error);
                document.getElementById('loader-dashboard').innerText = "Error cargando datos.";
            }
        }

        function calcularKPIs(datos) {
            // Contadores simples
            const totalCotizaciones = datos.length;
            const totalAprobadas = datos.filter(c => c.estatus === 'Aprobada' || c.estatus === 'Pagada').length;
            
            // Suma de dinero (Pendientes)
            const montoPendiente = datos
                .filter(c => !c.estatus || c.estatus === 'Pendiente' || c.estatus === 'Emitida')
                .reduce((sum, c) => sum + (c.total || 0), 0);

            // Suma de dinero (Aprobadas/Pagadas) -> Ingreso Real
            const montoAprobado = datos
                .filter(c => c.estatus === 'Aprobada' || c.estatus === 'Pagada')
                .reduce((sum, c) => sum + (c.total || 0), 0);

            // Actualizar HTML
            document.getElementById('kpi-total').innerText = totalCotizaciones;
            document.getElementById('kpi-aprobadas').innerText = totalAprobadas;
            
            // Formato de moneda
            const formatoMoneda = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
            document.getElementById('kpi-pendiente').innerText = formatoMoneda.format(montoPendiente);
            document.getElementById('kpi-dinero').innerText = formatoMoneda.format(montoAprobado);
        }

        function renderizarGraficas(datos) {
            
            // --- A. PREPARAR DATOS PARA PRODUCTOS ---
            const productosCount = {};
            datos.forEach(c => {
                if (c.items && Array.isArray(c.items)) {
                    c.items.forEach(item => {
                        const nombre = item.producto || "Desconocido";
                        // Sumamos la cantidad de piezas
                        productosCount[nombre] = (productosCount[nombre] || 0) + parseInt(item.cantidad || 1);
                    });
                }
            });

            // Ordenar productos de mayor a menor y tomar Top 5
            const productosOrdenados = Object.entries(productosCount)
                .sort((a, b) => b[1] - a[1]) // Orden descendente
                .slice(0, 10); // Top 10

            const labelsProd = productosOrdenados.map(p => p[0]);
            const dataProd = productosOrdenados.map(p => p[1]);

            // --- B. PREPARAR DATOS PARA ESTATUS ---
            const estatusCount = {};
            datos.forEach(c => {
                const estado = c.estatus || "Emitida";
                estatusCount[estado] = (estatusCount[estado] || 0) + 1;
            });
            const labelsEstatus = Object.keys(estatusCount);
            const dataEstatus = Object.values(estatusCount);

            // --- C. PREPARAR DATOS MENSUALES ---
            const mesesCount = {};
            datos.forEach(c => {
                const fecha = new Date(c.fecha);
                // Clave: "Septiembre 2025"
                const mesNombre = fecha.toLocaleString('es-MX', { month: 'long', year: 'numeric' });
                // Sumar monto total de esa cotizaci√≥n al mes
                mesesCount[mesNombre] = (mesesCount[mesNombre] || 0) + (c.total || 0);
            });
            // (Opcional) Ordenar cronol√≥gicamente requerir√≠a un poco m√°s de l√≥gica, 
            // aqu√≠ se ordenar√°n por aparici√≥n o alfab√©tico. 
            // Para simplificar, usamos las claves directas.
            const labelsMes = Object.keys(mesesCount);
            const dataMes = Object.values(mesesCount);


            // --- D. RENDERIZAR CHART.JS ---

            // 1. Gr√°fica Productos (Barras)
            new Chart(document.getElementById('chartProductos'), {
                type: 'bar',
                data: {
                    labels: labelsProd,
                    datasets: [{
                        label: 'Piezas Vendidas',
                        data: dataProd,
                        backgroundColor: '#007bff',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // 2. Gr√°fica Estatus (Pastel / Doughnut)
            new Chart(document.getElementById('chartEstatus'), {
                type: 'doughnut',
                data: {
                    labels: labelsEstatus,
                    datasets: [{
                        data: dataEstatus,
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6c757d']
                    }]
                },
                options: { responsive: true }
            });

            // 3. Gr√°fica Mensual (L√≠nea)
            new Chart(document.getElementById('chartMensual'), {
                type: 'line',
                data: {
                    labels: labelsMes,
                    datasets: [{
                        label: 'Monto Cotizado ($)',
                        data: dataMes,
                        borderColor: '#6610f2',
                        backgroundColor: 'rgba(102, 16, 242, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });
            // ... (Despu√©s del c√≥digo de la gr√°fica Mensual) ...

            // --- E. NUEVO: PREPARAR DATOS PARA M√âTODOS DE PAGO ---
            const pagosCount = {};
            
            datos.forEach(c => {
                // Verificamos si la cotizaci√≥n tiene pagos registrados
                if (c.pagos && Array.isArray(c.pagos)) {
                    c.pagos.forEach(p => {
                        // Tomamos el tipo (ej. "Efectivo") o "Desconocido" si fallara
                        const tipo = p.tipoPago || "Otros";
                        // Sumamos +1 al contador de ese tipo
                        pagosCount[tipo] = (pagosCount[tipo] || 0) + 1;
                    });
                }
            });

            const labelsPagos = Object.keys(pagosCount);
            const dataPagos = Object.values(pagosCount);

    
            new Chart(document.getElementById('chartPagos'), {
                type: 'pie', // Tipo Pastel
                data: {
                    labels: labelsPagos,
                    datasets: [{
                        data: dataPagos,
                        // Colores variados para diferenciar (Azul, Morado, Verde, Naranja, Rojo)
                        backgroundColor: ['#17a2b8', '#6f42c1', '#28a745', '#fd7e14', '#dc3545'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' } // Leyenda abajo para ahorrar espacio
                    }
                }
            });
        }

        // Ejecutar al cargar
        cargarDashboard();

    </script>
</body>
</html>