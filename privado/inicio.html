<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - Dashboard General</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS ESPEC√çFICOS DEL DASHBOARD --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .dashboard-container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        .welcome-banner {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- TARJETAS KPI (N√∫meros) --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            border-bottom: 4px solid #ddd;
        }
        .kpi-card h3 { margin: 0; color: #666; font-size: 0.9em; text-transform: uppercase; }
        .kpi-card p { margin: 10px 0 0 0; font-size: 1.8em; font-weight: bold; color: #001f3f; }

        .border-blue { border-bottom-color: #007bff; }
        .border-green { border-bottom-color: #28a745; }
        .border-red { border-bottom-color: #dc3545; }
        .border-orange { border-bottom-color: #fd7e14; }

        /* --- GRILLA DE GR√ÅFICAS (LAYOUT MEJORADO) --- */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr; /* M√≥vil: 1 columna */
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* En PC usamos 2 columnas */
        @media(min-width: 900px) {
            .charts-grid { 
                grid-template-columns: 1fr 1fr; 
            }
            
            /* CLASE M√ÅGICA: Hace que un elemento ocupe las 2 columnas */
            .span-full {
                grid-column: span 2;
            }
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        #loader-dashboard { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
    </style>
</head>
<body>

    <header class="header">
        <div class="nav-container">
            <div class="logo"><img src="/IMG/logo.jpeg" alt="Logo"></div>
            <nav class="nav-links">
                <a href="/index.html" class="btn-logout">Cerrar Sesi√≥n</a>
                <a href="/inicio.html" style="font-weight:bold; color:#17a2b8;">Inicio</a>
                <a href="/productos.html">Productos</a>
                <a href="/clientes.html">Clientes</a>
                <div class="dropdown">
                    <button class="dropbtn">Cotizaciones ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="/cotizaciones.html">Nueva Cotizaci√≥n</a>
                        <a href="/control-cotizaciones.html">Control Cotizaciones</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="dashboard-container">
        
        <div class="welcome-banner">
            <h1 style="margin:0;">üëã Bienvenido al Panel de Control</h1>
            <p style="margin:5px 0 0 0; opacity: 0.8;">Resumen de actividad (Excluyendo datos importados)</p>
        </div>

        <div id="loader-dashboard">üîÑ Analizando datos...</div>

        <div id="dashboard-content" style="display: none;">
            
            <div class="kpi-grid">
                <div class="kpi-card border-blue">
                    <h3>Cotizaciones Totales</h3>
                    <p id="kpi-total">0</p>
                </div>
                <div class="kpi-card border-green">
                    <h3>Ventas Aprobadas</h3>
                    <p id="kpi-aprobadas">0</p>
                </div>
                <div class="kpi-card border-orange">
                    <h3>Monto Pendiente</h3>
                    <p id="kpi-pendiente">$0.00</p>
                </div>
                <div class="kpi-card border-red">
                    <h3>Ingreso Estimado (Aprob)</h3>
                    <p id="kpi-dinero" style="color: #28a745;">$0.00</p>
                </div>
            </div>

            <div class="charts-grid">
                
                <div class="chart-card span-full">
                    <div class="chart-title">üèÜ Top Productos Cotizados (Por Piezas)</div>
                    <div style="height: 300px;">
                        <canvas id="chartProductos"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">üìä Estatus de Cotizaciones</div>
                    <canvas id="chartEstatus"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">üí≥ M√©todos de Pago</div>
                    <canvas id="chartPagos"></canvas>
                </div>
            </div>

            <div class="chart-card" style="margin-bottom: 20px;">
                <div class="chart-title">üìÖ Comportamiento Mensual (Monto Cotizado)</div>
                <div style="height: 300px;">
                    <canvas id="chartMensual"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        async function cargarDashboard() {
            try {
                const res = await fetch('/cotizaciones');
                const todosLosDatos = await res.json();

                // FILTRO: Ignorar "Importado"
                const datos = todosLosDatos.filter(c => c.quienCotiza !== 'Importado');

                if (datos.length === 0) {
                    document.getElementById('loader-dashboard').innerText = "No hay datos recientes.";
                    return;
                }

                calcularKPIs(datos);
                renderizarGraficas(datos);

                document.getElementById('loader-dashboard').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

            } catch (error) {
                console.error(error);
                document.getElementById('loader-dashboard').innerText = "Error cargando datos.";
            }
        }

        function calcularKPIs(datos) {
            const totalCotizaciones = datos.length;
            const totalAprobadas = datos.filter(c => c.estatus === 'Aprobada' || c.estatus === 'Pagada').length;
            
            const montoPendiente = datos
                .filter(c => !c.estatus || c.estatus === 'Pendiente' || c.estatus === 'Emitida')
                .reduce((sum, c) => sum + (c.total || 0), 0);

            const montoAprobado = datos
                .filter(c => c.estatus === 'Aprobada' || c.estatus === 'Pagada')
                .reduce((sum, c) => sum + (c.total || 0), 0);

            document.getElementById('kpi-total').innerText = totalCotizaciones;
            document.getElementById('kpi-aprobadas').innerText = totalAprobadas;
            
            const formatoMoneda = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
            document.getElementById('kpi-pendiente').innerText = formatoMoneda.format(montoPendiente);
            document.getElementById('kpi-dinero').innerText = formatoMoneda.format(montoAprobado);
        }

        function renderizarGraficas(datos) {
            
            // --- 1. DATOS PRODUCTOS ---
            const productosCount = {};
            datos.forEach(c => {
                if (c.items && Array.isArray(c.items)) {
                    c.items.forEach(item => {
                        const nombre = item.producto || "Desconocido";
                        productosCount[nombre] = (productosCount[nombre] || 0) + parseInt(item.cantidad || 1);
                    });
                }
            });
            const productosOrdenados = Object.entries(productosCount)
                .sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            const labelsProd = productosOrdenados.map(p => p[0]);
            const dataProd = productosOrdenados.map(p => p[1]);

            // --- 2. DATOS ESTATUS ---
            const estatusCount = {};
            datos.forEach(c => {
                const estado = c.estatus || "Emitida";
                estatusCount[estado] = (estatusCount[estado] || 0) + 1;
            });
            const labelsEstatus = Object.keys(estatusCount);
            const dataEstatus = Object.values(estatusCount);

            // --- 3. DATOS PAGOS (NUEVO) ---
            const pagosCount = {};
            datos.forEach(c => {
                // Buscamos dentro del array pagos de cada cotizaci√≥n
                if (c.pagos && Array.isArray(c.pagos)) {
                    c.pagos.forEach(p => {
                        const tipo = p.tipoPago || "Otros";
                        pagosCount[tipo] = (pagosCount[tipo] || 0) + 1;
                    });
                }
            });
            const labelsPagos = Object.keys(pagosCount);
            const dataPagos = Object.values(pagosCount);

            // --- 4. DATOS MENSUALES ---
            const mesesCount = {};
            datos.forEach(c => {
                const fecha = new Date(c.fecha);
                const mesNombre = fecha.toLocaleString('es-MX', { month: 'long', year: 'numeric' });
                mesesCount[mesNombre] = (mesesCount[mesNombre] || 0) + (c.total || 0);
            });
            const labelsMes = Object.keys(mesesCount);
            const dataMes = Object.values(mesesCount);


            // --- RENDERIZADO ---

            // Gr√°fica 1: Productos (Barras)
            new Chart(document.getElementById('chartProductos'), {
                type: 'bar',
                data: {
                    labels: labelsProd,
                    datasets: [{
                        label: 'Piezas Vendidas',
                        data: dataProd,
                        backgroundColor: '#007bff',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, // IMPORTANTE: Se adapta al contenedor alto
                    plugins: { legend: { display: false } } 
                }
            });

            // Gr√°fica 2: Estatus (Doughnut)
            new Chart(document.getElementById('chartEstatus'), {
                type: 'doughnut',
                data: {
                    labels: labelsEstatus,
                    datasets: [{
                        data: dataEstatus,
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6c757d']
                    }]
                },
                options: { responsive: true }
            });

            // Gr√°fica 3: Pagos (Pie) - NUEVA
            new Chart(document.getElementById('chartPagos'), {
                type: 'pie',
                data: {
                    labels: labelsPagos,
                    datasets: [{
                        data: dataPagos,
                        backgroundColor: ['#6610f2', '#fd7e14', '#20c997', '#e83e8c', '#6f42c1']
                    }]
                },
                options: { responsive: true }
            });

            // Gr√°fica 4: Mensual (Line)
            new Chart(document.getElementById('chartMensual'), {
                type: 'line',
                data: {
                    labels: labelsMes,
                    datasets: [{
                        label: 'Monto Cotizado ($)',
                        data: dataMes,
                        borderColor: '#6610f2',
                        backgroundColor: 'rgba(102, 16, 242, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        cargarDashboard();
    </script>
</body>
</html>